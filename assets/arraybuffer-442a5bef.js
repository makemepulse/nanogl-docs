function P(r){return r.fenceSync!==void 0}let m=0;class g{constructor(t,e,n,i){this.gl=t,this.program=t.createProgram(),this.vShader=t.createShader(t.VERTEX_SHADER),this.fShader=t.createShader(t.FRAGMENT_SHADER),this.dyns=[],this.ready=!1,t.attachShader(this.program,this.vShader),t.attachShader(this.program,this.fShader),this._uid=m++|0,this._cuid=m++|0,e!==void 0&&n!==void 0&&this.compile(e,n,i)}use(){this.ready||this._grabParameters(),this.gl.useProgram(this.program)}bind(){this.use()}compile(t,e,n){this.ready=!1,n=n===void 0?"":n+`
`;const i=this.gl;if(!(A(i,this.fShader,n+e)&&A(i,this.vShader,n+t)))return!1;if(i.linkProgram(this.program),!i.getProgramParameter(this.program,i.LINK_STATUS))return g.debug&&S(i.getProgramInfoLog(this.program)),!1;for(;this.dyns.length>0;)delete this[this.dyns.pop()];return this._cuid=m++|0,!0}dispose(){this.gl!==null&&(this.gl.deleteProgram(this.program),this.gl.deleteShader(this.fShader),this.gl.deleteShader(this.vShader))}_grabParameters(){const t=this.gl,e=this.program,n={texIndex:0,ublockIndex:0},i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(var a=0;a<i;++a){var f=t.getActiveUniform(e,a);if(f===null){t.getError();continue}var u=f.name,l=u.indexOf("[");l>=0&&(u=u.substring(0,l));var p=t.getUniformLocation(e,f.name);p!==null&&(this[u]=x(f.type,p,t,n),this.dyns.push(u))}const L=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(var d=0;d<L;++d){var c=t.getActiveAttrib(e,d).name,_=t.getAttribLocation(e,c);this[c]=I(_),this.dyns.push(c)}if(P(t)){const w=t.getProgramParameter(e,t.ACTIVE_UNIFORM_BLOCKS);for(var o=0;o<w;++o){var b=t.getActiveUniformBlockName(e,o);this[b]=C(o,t,n),this.dyns.push(b)}}this.ready=!0}}g.debug=!1;function S(r){console.warn(r)}const T=["","   ","  "," ",""];function v(r,t){return T[String(t+1).length]+(t+1)+": "+r}function E(r){return r.split(`
`).map(v).join(`
`)}const R=/^ERROR:\s?(\d+):(\d+)/;function U(r,t){const e=t.split(`
`);r=r.split(`
`).map(n=>{const i=R.exec(n);return i&&(n+=`
  > `+e[parseInt(i[2])-1]),n}).join(`
`),t=E(t),S(r),S(t)}function A(r,t,e){return r.shaderSource(t,e),r.compileShader(t),r.getShaderParameter(t,r.COMPILE_STATUS)?!0:(g.debug&&U(r.getShaderInfoLog(t),e),!1)}const s={};s[String(5126)]="1f";s[String(35664)]="2f";s[String(35665)]="3f";s[String(35666)]="4f";s[String(35670)]=s[String(5124)]=s[String(35678)]=s[String(35680)]=s[String(35866)]="1i";s[String(35671)]=s[String(35667)]="2i";s[String(35672)]=s[String(35668)]="3i";s[String(35673)]=s[String(35669)]="4i";s[String(35674)]="Matrix2f";s[String(35675)]="Matrix3f";s[String(35676)]="Matrix4f";function B(r){return"uniform"+s[String(r)]}function x(r,t,e,n){switch(r){case e.FLOAT_MAT2:case e.FLOAT_MAT3:case e.FLOAT_MAT4:return y(r,t,e);case e.SAMPLER_2D:case e.SAMPLER_CUBE:case 35682:case 35679:case 36289:return M(r,t,e,n);default:return F(r,t,e)}}function F(r,t,e,n){const i=B(r);return function(...a){return a.length===1&&a[0].length!=null?e[i+"v"](t,a[0]):a.length>0&&e[i](t,...a),t}}function y(r,t,e,n){const i=B(r);return function(){if(arguments.length>0&&arguments[0].length!==void 0){var a=arguments.length>1?!!arguments[1]:!1;e[i+"v"](t,a,arguments[0])}return t}}function M(r,t,e,n){const i=n.texIndex++;return function(){return arguments.length===1&&(arguments[0].bind!==void 0?(arguments[0].bind(i),e.uniform1i(t,i)):e.uniform1i(t,arguments[0])),t}}function C(r,t,e){const n=e.ublockIndex++;return function(){return arguments.length===1&&(arguments[0]instanceof WebGLBuffer?(t.uniformBlockBinding(this.program,r,n),t.bindBufferBase(t.UNIFORM_BUFFER,n,arguments[0])):t.uniformBlockBinding(this.program,r,arguments[0])),r}}function I(r){return function(){return r}}class O{drawPoints(t,e){this.draw(0,t,e)}drawLines(t,e){this.draw(1,t,e)}drawLineLoop(t,e){this.draw(2,t,e)}drawLineStrip(t,e){this.draw(3,t,e)}drawTriangles(t,e){this.draw(4,t,e)}drawTriangleStrip(t,e){this.draw(5,t,e)}drawTriangleFan(t,e){this.draw(6,t,e)}}function D(r){return r.byteLength!==void 0}function V(r){switch(r){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`unknown type ${r}`)}}const h=34962;class k extends O{constructor(t,e,n=t.STATIC_DRAW,i){super(),this.gl=t,this.usage=n,this.buffer=i!==void 0?i:t.createBuffer(),this.attribs=[],this.stride=0,this.byteLength=0,this.length=0,e&&this.data(e)}bind(){this.gl.bindBuffer(h,this.buffer)}attrib(t,e,n,i=!1){return this.attribs.push({name:t,type:0|n,size:0|e,normalize:i,offset:this.stride,stride:0}),this.stride+=V(n)*e,this._computeLength(),this}data(t){const e=this.gl;e.bindBuffer(h,this.buffer),e.bufferData(h,t,this.usage),e.bindBuffer(h,null),this.byteLength=D(t)?t.byteLength:t,this._computeLength()}subData(t,e){const n=this.gl;n.bindBuffer(h,this.buffer),n.bufferSubData(h,e,t),n.bindBuffer(h,null)}attribPointer(t){const e=this.gl;e.bindBuffer(h,this.buffer);for(var n=0;n<this.attribs.length;n++){var i=this.attribs[n];if(t[i.name]!==void 0){var a=t[i.name]();e.enableVertexAttribArray(a),e.vertexAttribPointer(a,i.size,i.type,i.normalize,i.stride||this.stride,i.offset)}}}draw(t,e=this.length,n=0){this.gl.drawArrays(t,n,0|e)}dispose(){this.gl.deleteBuffer(this.buffer)}_computeLength(){this.stride>0&&(this.length=this.byteLength/this.stride)}}export{k as A,g as P};
