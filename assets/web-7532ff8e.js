import{N as Ge,C as Ze,P as Ke,O as Qe}from"./index-099e42fb.js";import{g as et,a as tt,m as rt,M as nt,E as st,S as it,C as Te,U as at,b as ct,F as Me,I as lt,c as ht,T as ot,d as He}from"./ShaderVersion-75aae7d1.js";import{D as ft,M as Ye,S as mt,B as Ee}from"./Bounds-c261caf0.js";import{a as pt,A as ut}from"./arraybuffer-7f1df196.js";import{I as dt,G as Et}from"./indexbuffer-5b89fc58.js";import{T as gt}from"./texture-2d-53b1df66.js";var me={};me.byteLength=wt;me.toByteArray=yt;me.fromByteArray=Tt;var k=[],Y=[],At=typeof Uint8Array<"u"?Uint8Array:Array,ue="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Q=0,_t=ue.length;Q<_t;++Q)k[Q]=ue[Q],Y[ue.charCodeAt(Q)]=Q;Y["-".charCodeAt(0)]=62;Y["_".charCodeAt(0)]=63;function $e(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");r===-1&&(r=t);var n=r===t?0:4-r%4;return[r,n]}function wt(e){var t=$e(e),r=t[0],n=t[1];return(r+n)*3/4-n}function vt(e,t,r){return(t+r)*3/4-r}function yt(e){var t,r=$e(e),n=r[0],s=r[1],i=new At(vt(e,n,s)),a=0,c=s>0?n-4:n,l;for(l=0;l<c;l+=4)t=Y[e.charCodeAt(l)]<<18|Y[e.charCodeAt(l+1)]<<12|Y[e.charCodeAt(l+2)]<<6|Y[e.charCodeAt(l+3)],i[a++]=t>>16&255,i[a++]=t>>8&255,i[a++]=t&255;return s===2&&(t=Y[e.charCodeAt(l)]<<2|Y[e.charCodeAt(l+1)]>>4,i[a++]=t&255),s===1&&(t=Y[e.charCodeAt(l)]<<10|Y[e.charCodeAt(l+1)]<<4|Y[e.charCodeAt(l+2)]>>2,i[a++]=t>>8&255,i[a++]=t&255),i}function St(e){return k[e>>18&63]+k[e>>12&63]+k[e>>6&63]+k[e&63]}function xt(e,t,r){for(var n,s=[],i=t;i<r;i+=3)n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(e[i+2]&255),s.push(St(n));return s.join("")}function Tt(e){for(var t,r=e.length,n=r%3,s=[],i=16383,a=0,c=r-n;a<c;a+=i)s.push(xt(e,a,a+i>c?c:a+i));return n===1?(t=e[r-1],s.push(k[t>>2]+k[t<<4&63]+"==")):n===2&&(t=(e[r-2]<<8)+e[r-1],s.push(k[t>>10]+k[t>>4&63]+k[t<<2&63]+"=")),s.join("")}const Mt=typeof TextDecoder<"u"?new TextDecoder("utf-8"):null;function ae(e,t,r){return t<=e&&e<=r}function Rt(e){let t=0,r=0,n=0,s=128,i=191;const a=[],c=e.length;for(let l=0;l<c;++l){const h=e[l];if(n===0){if(ae(h,0,127)){a.push(h);continue}if(ae(h,194,223)){n=1,t=h&31;continue}if(ae(h,224,239)){h===224&&(s=160),h===237&&(i=159),n=2,t=h&15;continue}if(ae(h,240,244)){h===240&&(s=144),h===244&&(i=143),n=3,t=h&7;continue}throw new Error("String decoding failed.")}if(!ae(h,s,i)){t=n=r=0,s=128,i=191,--l;continue}s=128,i=191,t=t<<6|h&63,++r,r===n&&(a.push(t),t=n=r=0)}return a}function It(e){return Mt.decode(e)}function bt(e){let t="";const r=Rt(e);for(let n of r)n<=65535?t+=String.fromCharCode(n):(n-=65536,t+=String.fromCharCode((n>>10)+55296,(n&1023)+56320));return t}const Ct=typeof TextDecoder<"u"?It:bt;function oe(e){throw new Error(e)}const j={isDefined(e,t=""){e===void 0&&oe(t)},isUndefined(e,t=""){e!==void 0&&oe(t)},isTrue(e,t=""){e!==!0&&oe(t)},isFalse(e,t=""){e!==!1&&oe(t)}};class Nt{constructor(){this._map={},this._list=[]}addExtension(t){if(this._map[t.name]!==void 0)throw new Error(`Extension ${t.name} already exits`);this._map[t.name]=t,this._list.push(t)}sort(){this._list.sort((t,r)=>r.priority-t.priority)}validate(t=[],r=[]){for(const n of t)this._map[n]===void 0&&console.warn(`Missing used extension ${n}`);for(const n of r)if(this._map[n]===void 0)throw new Error(`Missing required extension ${n}`)}}class Pt{constructor(){this._extensionFactories={}}addExtension(t){const r=t.name;j.isUndefined(this._extensionFactories[r],`extension '${r}' already exist`),this._extensionFactories[r]=t}setupExtensions(t,r=[]){const n=t._extensions;for(const s in this._extensionFactories){const i=this._extensionFactories[s].createInstance(t);j.isTrue(i.name===s),n.addExtension(i)}for(const s of r){const i=s.createInstance(t);n.addExtension(i)}n.sort()}}const Ot={POSITION:{indexed:!1,attrib:"aPosition"},NORMAL:{indexed:!1,attrib:"aNormal"},TANGENT:{indexed:!1,attrib:"aTangent"},TEXCOORD:{indexed:!0,attrib:"aTexCoord"},COLOR:{indexed:!0,attrib:"aColor"},JOINTS:{indexed:!0,attrib:"aSkinJoints"},WEIGHTS:{indexed:!0,attrib:"aSkinWeights"}};class Ft{getMorphedAttributeName(t,r){return this.getAttributeName(t)+"_mt"+r}getAttributeName(t){const[r,n=0]=t.split("_"),s=Ot[r];if(s!==void 0)return n>0||s.indexed?s.attrib+n:s.attrib;throw new Error(`Invalid Semantic ${t}`)}}var ge;(function(e){e.ACCESSOR="accessors",e.ACCESSOR_SPARSE="sparse",e.ACCESSOR_SPARSE_INDICES="sparseIndices",e.ACCESSOR_SPARSE_VALUES="sparseValues",e.ANIMATION="animations",e.ANIMATION_SAMPLER="animationSamplers",e.ANIMATION_CHANNEL="animationChannels",e.ASSET="asset",e.BUFFER="buffers",e.BUFFERVIEW="bufferViews",e.CAMERA="cameras",e.IMAGE="images",e.MATERIAL="materials",e.MESH="meshes",e.NODE="nodes",e.NORMAL_TEXTURE_INFO="normalTextureInfo",e.OCCLUSION_TEXTURE_INFO="occlusionTextureInfo",e.PRIMITIVE="primitives",e.SAMPLER="samplers",e.SCENE="scenes",e.SKIN="skins",e.TEXTURE="textures",e.TEXTURE_INFO="textureInfo"})(ge||(ge={}));const f=ge;function Lt(){return{opaqueMask:1<<0,blendedMask:1<<1}}var ee=function(e){var t="";return t+=`
#pragma SLOT version

#pragma SLOT definitions


#ifndef hasNormals
  #define hasNormals 1
#endif 
#ifndef hasTangents
  #define hasTangents hasNormals
#endif 

#if hasTangents && !hasNormals 
  #pragma error tan but no nrm
  error
#endif

#pragma SLOT precision

`+et()+`

#pragma SLOT pv


IN vec3 aPosition;


// uniform mat4 uMVP;
uniform mat4 uWorldMatrix;
uniform mat4 uVP;


#if depthFormat( D_RGB )
  OUT vec2 fragZW;
#endif


struct VertexData {
  highp vec3 position;
  highp vec3 worldPos;
  #if hasNormals
    vec3 normal;
  #endif
  #if hasTangents
    vec3 tangent;
  #endif
  mat4 worldMatrix;
};


void InitVertexData( out VertexData vertex ){

  vertex.position = aPosition;
  #if hasNormals
    vertex.normal = vec3(0.0);
  #endif
  #if hasTangents
    vertex.tangent = vec3(0.0);
  #endif

  vertex.worldMatrix = uWorldMatrix;
   
}



void main( void ){

  #pragma SLOT v

  VertexData vertex;
  InitVertexData( vertex );

  #pragma SLOT vertex_warp

  vec4 worldPos = vertex.worldMatrix * vec4( vertex.position, 1.0 );
  vertex.worldPos.xyz = worldPos.xyz / worldPos.w;

  #pragma SLOT vertex_warp_world

  gl_Position     = uVP * vec4( vertex.worldPos, 1.0 );

  #if depthFormat( D_RGB )
    fragZW=gl_Position.zw;
  #endif

  #pragma SLOT postv

}
`,t};ee.toString=ee;var Bt=ee;ee._hmrListeners=[];ee.onHmr=function(e){this._hmrListeners.push(e)};ee._triggerHmr=function(){for(const e of this._hmrListeners)e(this)};var te=function(e){var t="";return t+=`#pragma SLOT version

#pragma SLOT definitions

#pragma SLOT precision

`+tt()+`

#pragma SLOT pf


#if depthFormat( D_RGB )
  IN vec2 fragZW;

  vec3 encodeDepthRGB(float depth){
    vec4 c = vec4(1.0,255.0,65025.0,16581375.0)*depth;
    c=fract(c);
    c.xyz-=c.yzw*(1.0/255.0);
    return c.xyz;
  }
#endif



void main(void){

  #pragma SLOT f
  
  #if depthFormat( D_RGB )
    gl_FragColor.xyz = encodeDepthRGB( ( fragZW.x / fragZW.y ) * 0.5 + 0.5 );
    gl_FragColor.w=0.0;
  #endif

  #if depthFormat( D_DEPTH )
    gl_FragColor = vec4( 0.0 );
  #endif

}
`,t};te.toString=te;var Vt=te;te._hmrListeners=[];te.onHmr=function(e){this._hmrListeners.push(e)};te._triggerHmr=function(){for(const e of this._hmrListeners)e(this)};const Re=rt.create();class Ut extends nt{constructor(t){super({uid:"stddepth",vert:Bt(),frag:Vt()}),this.depthFormat=this.inputs.add(new st("depthFormat",ft)),this.precision=this.inputs.add(new it("highp"))}setLightSetup(t){this.depthFormat.proxy(t==null?void 0:t.depthFormat)}prepare(t,r,n){t.uMVP&&(n.modelViewProjectionMatrix(Re,r._wmatrix),t.uMVP(Re)),t.uWorldMatrix&&t.uWorldMatrix(r._wmatrix),t.uVP&&t.uVP(n._viewProj)}}const ce=new WeakMap,de=new WeakMap;class q{constructor(){this.onabort=null,ce.set(this,[]),de.set(this,!1)}get aborted(){if(!de.has(this))throw new TypeError("Expected `this` to be an instance of AbortSignal.");return de.get(this)}static get none(){return new q}addEventListener(t,r){if(!ce.has(this))throw new TypeError("Expected `this` to be an instance of AbortSignal.");ce.get(this).push(r)}removeEventListener(t,r){if(!ce.has(this))throw new TypeError("Expected `this` to be an instance of AbortSignal.");const n=ce.get(this),s=n.indexOf(r);s>-1&&n.splice(s,1)}dispatchEvent(t){throw new Error("This is a stub dispatchEvent implementation that should not be used.  It only exists for type-checking purposes.")}}class Dt extends Error{constructor(t){super(t),this.name="AbortError"}}class O{constructor(){this.indexed=[],this.list=[]}addElement(t,r=-1){r>-1&&(this.indexed[r]=t),this.list.push(t)}}class H{constructor(){this.root=new Ge,this.extras={},this._collections=new Map([[f.ACCESSOR,new O],[f.ACCESSOR_SPARSE,new O],[f.ACCESSOR_SPARSE_INDICES,new O],[f.ACCESSOR_SPARSE_VALUES,new O],[f.ANIMATION,new O],[f.ANIMATION_SAMPLER,new O],[f.ANIMATION_CHANNEL,new O],[f.ASSET,new O],[f.BUFFER,new O],[f.BUFFERVIEW,new O],[f.CAMERA,new O],[f.IMAGE,new O],[f.MATERIAL,new O],[f.MESH,new O],[f.NODE,new O],[f.NORMAL_TEXTURE_INFO,new O],[f.OCCLUSION_TEXTURE_INFO,new O],[f.PRIMITIVE,new O],[f.SAMPLER,new O],[f.SCENE,new O],[f.SKIN,new O],[f.TEXTURE,new O],[f.TEXTURE_INFO,new O]]),this._elements=[]}static addExtension(t){H._extensionsRegistry.addExtension(t)}static getSemantics(){return this._semantics}static setSemantics(t){t??(this._semantics=t)}static getRenderConfig(){return this._renderConfig}static getExtensionsRegistry(){return this._extensionsRegistry}async allocate(t,r=q.none){this.gl=t,this.depthPass=new Ut(t),this.depthPass.depthFormat.set("D_RGB");for(const n of this.textures)if(await n.allocateGl(t),r.aborted)throw new Dt("Aborted");this.primitives.forEach(n=>n.allocateGl(t)),this.nodes.forEach(n=>n.allocateGl(this)),this.renderables=this.nodes.map(n=>n.renderable).filter(n=>n!==void 0);for(const n of this.nodes)n._parent||this.root.add(n);this.createCameras()}createCameras(){this.cameraInstances=this.nodes.filter(t=>t.camera!==void 0).map(t=>{const r=new Ze(t.camera.lens);return t.add(r),r})}get buffers(){return this._getCollection(f.BUFFER).list}get bufferViews(){return this._getCollection(f.BUFFERVIEW).list}get accessors(){return this._getCollection(f.ACCESSOR).list}get animations(){return this._getCollection(f.ANIMATION).list}get meshes(){return this._getCollection(f.MESH).list}get nodes(){return this._getCollection(f.NODE).list}get materials(){return this._getCollection(f.MATERIAL).list}get cameras(){return this._getCollection(f.CAMERA).list}get skins(){return this._getCollection(f.SKIN).list}get primitives(){return this._getCollection(f.PRIMITIVE).list}get textures(){return this._getCollection(f.TEXTURE).list}getAllElements(){return this._elements}getElement(t,r){return this._getCollection(t).indexed[r]}getElementByName(t,r){const n=this._getCollection(t).list;for(const s of n)if(s.name===r)return s;return null}getElementsByName(t,r){const n=this._getCollection(t).list,s=[];for(const i of n)i.name===r&&s.push(i);return s}getNode(t){return this.getElementByName(f.NODE,t)}getMesh(t){return this.getElementByName(f.MESH,t)}getMaterial(t){return this.getElementByName(f.MATERIAL,t)}getAnimation(t){return this.getElementByName(f.ANIMATION,t)}_getCollection(t){return this._collections.get(t)}addElement(t,r=-1){this._getCollection(t.gltftype).addElement(t,r),this._elements.push(t)}}H._extensionsRegistry=new Pt;H._semantics=new Ft;H._renderConfig=Lt();class zt{constructor(){this.gltftype=f.ANIMATION,this.duration=0}async parse(t,r){const n=r.samplers.map(i=>t._loadElement(i));this.samplers=await Promise.all(n);for(const i of this.samplers)this.duration=Math.max(i.maxTime);const s=r.channels.map(i=>t._loadElement(i));this.channels=await Promise.all(s)}evaluate(t){for(const r of this.channels)r.evaluate(t)}getChannel(t){return this.channels[t]}getSampler(t){return this.samplers[t]}}var Ae;(function(e){(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT"})(e.AccessorComponentType||(e.AccessorComponentType={})),function(t){t.SCALAR="SCALAR",t.VEC2="VEC2",t.VEC3="VEC3",t.VEC4="VEC4",t.MAT2="MAT2",t.MAT3="MAT3",t.MAT4="MAT4"}(e.AccessorType||(e.AccessorType={})),function(t){t.TRANSLATION="translation",t.ROTATION="rotation",t.SCALE="scale",t.WEIGHTS="weights"}(e.AnimationChannelTargetPath||(e.AnimationChannelTargetPath={})),function(t){t.LINEAR="LINEAR",t.STEP="STEP",t.CUBICSPLINE="CUBICSPLINE"}(e.AnimationSamplerInterpolation||(e.AnimationSamplerInterpolation={})),function(t){t.PERSPECTIVE="perspective",t.ORTHOGRAPHIC="orthographic"}(e.CameraType||(e.CameraType={})),function(t){t.JPEG="image/jpeg",t.PNG="image/png"}(e.ImageMimeType||(e.ImageMimeType={})),function(t){t.OPAQUE="OPAQUE",t.MASK="MASK",t.BLEND="BLEND"}(e.MaterialAlphaMode||(e.MaterialAlphaMode={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t[t.DEFAULT=4]="DEFAULT"}(e.MeshPrimitiveMode||(e.MeshPrimitiveMode={})),function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR"}(e.TextureMagFilter||(e.TextureMagFilter={})),function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(e.TextureMinFilter||(e.TextureMinFilter={})),function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.REPEAT=10497]="REPEAT"}(e.TextureWrapMode||(e.TextureWrapMode={}))})(Ae||(Ae={}));const y=Ae;function Gt(e,t){e.position.set(t),e.invalidate()}function Ht(e,t){e.rotation.set(t),e.invalidate()}function Yt(e,t){e.scale.set(t),e.invalidate()}function $t(e,t){e.weights.set(t)}function kt(e){switch(e){case y.AnimationChannelTargetPath.TRANSLATION:return Gt;case y.AnimationChannelTargetPath.ROTATION:return Ht;case y.AnimationChannelTargetPath.SCALE:return Yt;case y.AnimationChannelTargetPath.WEIGHTS:return $t;default:throw new Error("unsupported path "+e)}}class Wt{constructor(){this.gltftype=f.ANIMATION_CHANNEL}async parse(t,r){if(this._active=!1,this.path=r.target.path,this.applyFunction=kt(this.path),r.target.node!==void 0){this._active=!0,this.node=await t.getElement(f.NODE,r.target.node);let n=1;this.path===y.AnimationChannelTargetPath.WEIGHTS&&(n=this.node.mesh.primitives[0].targets.length),t._loadElement(r.elementParent).then(s=>{this.sampler=s.getSampler(r.sampler),this.evaluator=this.sampler.createEvaluator(this.path,n),this.valueHolder=this.evaluator.createElementHolder()})}}evaluate(t){this._active&&(this.evaluator.evaluate(this.valueHolder,t),this.applyFunction(this.node,this.valueHolder))}}var se={};se.EPSILON=1e-6;se.ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array;se.RANDOM=Math.random;se.setMatrixArrayType=function(e){GLMAT_ARRAY_TYPE=e};var Xt=Math.PI/180;se.toRadian=function(e){return e*Xt};var J=se,ke=J,U={};U.create=function(){var e=new ke.ARRAY_TYPE(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e};U.clone=function(e){var t=new ke.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};U.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e};U.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e};U.transpose=function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e};U.invert=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=r*i-s*n;return a?(a=1/a,e[0]=i*a,e[1]=-n*a,e[2]=-s*a,e[3]=r*a,e):null};U.adjoint=function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e};U.determinant=function(e){return e[0]*e[3]-e[2]*e[1]};U.multiply=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=r[0],l=r[1],h=r[2],o=r[3];return e[0]=n*c+i*l,e[1]=s*c+a*l,e[2]=n*h+i*o,e[3]=s*h+a*o,e};U.mul=U.multiply;U.rotate=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=Math.sin(r),l=Math.cos(r);return e[0]=n*l+i*c,e[1]=s*l+a*c,e[2]=n*-c+i*l,e[3]=s*-c+a*l,e};U.scale=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=r[0],l=r[1];return e[0]=n*c,e[1]=s*c,e[2]=i*l,e[3]=a*l,e};U.fromRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e};U.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e};U.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"};U.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))};U.LDU=function(e,t,r,n){return e[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-e[2]*r[1],[e,t,r]};var We=J,G={};G.create=function(){var e=new We.ARRAY_TYPE(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e};G.clone=function(e){var t=new We.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t};G.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e};G.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e};G.invert=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=r*i-n*s;return l?(l=1/l,e[0]=i*l,e[1]=-n*l,e[2]=-s*l,e[3]=r*l,e[4]=(s*c-i*a)*l,e[5]=(n*a-r*c)*l,e):null};G.determinant=function(e){return e[0]*e[3]-e[1]*e[2]};G.multiply=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=r[0],o=r[1],m=r[2],p=r[3],u=r[4],d=r[5];return e[0]=n*h+i*o,e[1]=s*h+a*o,e[2]=n*m+i*p,e[3]=s*m+a*p,e[4]=n*u+i*d+c,e[5]=s*u+a*d+l,e};G.mul=G.multiply;G.rotate=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=Math.sin(r),o=Math.cos(r);return e[0]=n*o+i*h,e[1]=s*o+a*h,e[2]=n*-h+i*o,e[3]=s*-h+a*o,e[4]=c,e[5]=l,e};G.scale=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=r[0],o=r[1];return e[0]=n*h,e[1]=s*h,e[2]=i*o,e[3]=a*o,e[4]=c,e[5]=l,e};G.translate=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=r[0],o=r[1];return e[0]=n,e[1]=s,e[2]=i,e[3]=a,e[4]=n*h+i*o+c,e[5]=s*h+a*o+l,e};G.fromRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e[4]=0,e[5]=0,e};G.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e};G.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e};G.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"};G.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)};var Xe=J,P={};P.create=function(){var e=new Xe.ARRAY_TYPE(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e};P.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e};P.clone=function(e){var t=new Xe.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t};P.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e};P.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e};P.transpose=function(e,t){if(e===t){var r=t[1],n=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e};P.invert=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],h=t[7],o=t[8],m=o*a-c*h,p=-o*i+c*l,u=h*i-a*l,d=r*m+n*p+s*u;return d?(d=1/d,e[0]=m*d,e[1]=(-o*n+s*h)*d,e[2]=(c*n-s*a)*d,e[3]=p*d,e[4]=(o*r-s*l)*d,e[5]=(-c*r+s*i)*d,e[6]=u*d,e[7]=(-h*r+n*l)*d,e[8]=(a*r-n*i)*d,e):null};P.adjoint=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],h=t[7],o=t[8];return e[0]=a*o-c*h,e[1]=s*h-n*o,e[2]=n*c-s*a,e[3]=c*l-i*o,e[4]=r*o-s*l,e[5]=s*i-r*c,e[6]=i*h-a*l,e[7]=n*l-r*h,e[8]=r*a-n*i,e};P.determinant=function(e){var t=e[0],r=e[1],n=e[2],s=e[3],i=e[4],a=e[5],c=e[6],l=e[7],h=e[8];return t*(h*i-a*l)+r*(-h*s+a*c)+n*(l*s-i*c)};P.multiply=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=t[6],o=t[7],m=t[8],p=r[0],u=r[1],d=r[2],g=r[3],E=r[4],A=r[5],b=r[6],v=r[7],w=r[8];return e[0]=p*n+u*a+d*h,e[1]=p*s+u*c+d*o,e[2]=p*i+u*l+d*m,e[3]=g*n+E*a+A*h,e[4]=g*s+E*c+A*o,e[5]=g*i+E*l+A*m,e[6]=b*n+v*a+w*h,e[7]=b*s+v*c+w*o,e[8]=b*i+v*l+w*m,e};P.mul=P.multiply;P.translate=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=t[6],o=t[7],m=t[8],p=r[0],u=r[1];return e[0]=n,e[1]=s,e[2]=i,e[3]=a,e[4]=c,e[5]=l,e[6]=p*n+u*a+h,e[7]=p*s+u*c+o,e[8]=p*i+u*l+m,e};P.rotate=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=t[6],o=t[7],m=t[8],p=Math.sin(r),u=Math.cos(r);return e[0]=u*n+p*a,e[1]=u*s+p*c,e[2]=u*i+p*l,e[3]=u*a-p*n,e[4]=u*c-p*s,e[5]=u*l-p*i,e[6]=h,e[7]=o,e[8]=m,e};P.scale=function(e,t,r){var n=r[0],s=r[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e};P.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e};P.fromRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=-r,e[4]=n,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e};P.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e};P.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e};P.fromQuat=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=r+r,c=n+n,l=s+s,h=r*a,o=n*a,m=n*c,p=s*a,u=s*c,d=s*l,g=i*a,E=i*c,A=i*l;return e[0]=1-m-d,e[3]=o-A,e[6]=p+E,e[1]=o+A,e[4]=1-h-d,e[7]=u-g,e[2]=p-E,e[5]=u+g,e[8]=1-h-m,e};P.normalFromMat4=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],h=t[7],o=t[8],m=t[9],p=t[10],u=t[11],d=t[12],g=t[13],E=t[14],A=t[15],b=r*c-n*a,v=r*l-s*a,w=r*h-i*a,x=n*l-s*c,S=n*h-i*c,B=s*h-i*l,F=o*g-m*d,L=o*E-p*d,N=o*A-u*d,D=m*E-p*g,V=m*A-u*g,z=p*A-u*E,I=b*z-v*V+w*D+x*N-S*L+B*F;return I?(I=1/I,e[0]=(c*z-l*V+h*D)*I,e[1]=(l*N-a*z-h*L)*I,e[2]=(a*V-c*N+h*F)*I,e[3]=(s*V-n*z-i*D)*I,e[4]=(r*z-s*N+i*L)*I,e[5]=(n*N-r*V-i*F)*I,e[6]=(g*B-E*S+A*x)*I,e[7]=(E*w-d*B-A*v)*I,e[8]=(d*S-g*w+A*b)*I,e):null};P.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"};P.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))};var qt=P,K=J,C={};C.create=function(){var e=new K.ARRAY_TYPE(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.clone=function(e){var t=new K.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t};C.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e};C.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.transpose=function(e,t){if(e===t){var r=t[1],n=t[2],s=t[3],i=t[6],a=t[7],c=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=i,e[11]=t[14],e[12]=s,e[13]=a,e[14]=c}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e};C.invert=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],h=t[7],o=t[8],m=t[9],p=t[10],u=t[11],d=t[12],g=t[13],E=t[14],A=t[15],b=r*c-n*a,v=r*l-s*a,w=r*h-i*a,x=n*l-s*c,S=n*h-i*c,B=s*h-i*l,F=o*g-m*d,L=o*E-p*d,N=o*A-u*d,D=m*E-p*g,V=m*A-u*g,z=p*A-u*E,I=b*z-v*V+w*D+x*N-S*L+B*F;return I?(I=1/I,e[0]=(c*z-l*V+h*D)*I,e[1]=(s*V-n*z-i*D)*I,e[2]=(g*B-E*S+A*x)*I,e[3]=(p*S-m*B-u*x)*I,e[4]=(l*N-a*z-h*L)*I,e[5]=(r*z-s*N+i*L)*I,e[6]=(E*w-d*B-A*v)*I,e[7]=(o*B-p*w+u*v)*I,e[8]=(a*V-c*N+h*F)*I,e[9]=(n*N-r*V-i*F)*I,e[10]=(d*S-g*w+A*b)*I,e[11]=(m*w-o*S-u*b)*I,e[12]=(c*L-a*D-l*F)*I,e[13]=(r*D-n*L+s*F)*I,e[14]=(g*v-d*x-E*b)*I,e[15]=(o*x-m*v+p*b)*I,e):null};C.adjoint=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],h=t[7],o=t[8],m=t[9],p=t[10],u=t[11],d=t[12],g=t[13],E=t[14],A=t[15];return e[0]=c*(p*A-u*E)-m*(l*A-h*E)+g*(l*u-h*p),e[1]=-(n*(p*A-u*E)-m*(s*A-i*E)+g*(s*u-i*p)),e[2]=n*(l*A-h*E)-c*(s*A-i*E)+g*(s*h-i*l),e[3]=-(n*(l*u-h*p)-c*(s*u-i*p)+m*(s*h-i*l)),e[4]=-(a*(p*A-u*E)-o*(l*A-h*E)+d*(l*u-h*p)),e[5]=r*(p*A-u*E)-o*(s*A-i*E)+d*(s*u-i*p),e[6]=-(r*(l*A-h*E)-a*(s*A-i*E)+d*(s*h-i*l)),e[7]=r*(l*u-h*p)-a*(s*u-i*p)+o*(s*h-i*l),e[8]=a*(m*A-u*g)-o*(c*A-h*g)+d*(c*u-h*m),e[9]=-(r*(m*A-u*g)-o*(n*A-i*g)+d*(n*u-i*m)),e[10]=r*(c*A-h*g)-a*(n*A-i*g)+d*(n*h-i*c),e[11]=-(r*(c*u-h*m)-a*(n*u-i*m)+o*(n*h-i*c)),e[12]=-(a*(m*E-p*g)-o*(c*E-l*g)+d*(c*p-l*m)),e[13]=r*(m*E-p*g)-o*(n*E-s*g)+d*(n*p-s*m),e[14]=-(r*(c*E-l*g)-a*(n*E-s*g)+d*(n*l-s*c)),e[15]=r*(c*p-l*m)-a*(n*p-s*m)+o*(n*l-s*c),e};C.determinant=function(e){var t=e[0],r=e[1],n=e[2],s=e[3],i=e[4],a=e[5],c=e[6],l=e[7],h=e[8],o=e[9],m=e[10],p=e[11],u=e[12],d=e[13],g=e[14],E=e[15],A=t*a-r*i,b=t*c-n*i,v=t*l-s*i,w=r*c-n*a,x=r*l-s*a,S=n*l-s*c,B=h*d-o*u,F=h*g-m*u,L=h*E-p*u,N=o*g-m*d,D=o*E-p*d,V=m*E-p*g;return A*V-b*D+v*N+w*L-x*F+S*B};C.multiply=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=t[4],l=t[5],h=t[6],o=t[7],m=t[8],p=t[9],u=t[10],d=t[11],g=t[12],E=t[13],A=t[14],b=t[15],v=r[0],w=r[1],x=r[2],S=r[3];return e[0]=v*n+w*c+x*m+S*g,e[1]=v*s+w*l+x*p+S*E,e[2]=v*i+w*h+x*u+S*A,e[3]=v*a+w*o+x*d+S*b,v=r[4],w=r[5],x=r[6],S=r[7],e[4]=v*n+w*c+x*m+S*g,e[5]=v*s+w*l+x*p+S*E,e[6]=v*i+w*h+x*u+S*A,e[7]=v*a+w*o+x*d+S*b,v=r[8],w=r[9],x=r[10],S=r[11],e[8]=v*n+w*c+x*m+S*g,e[9]=v*s+w*l+x*p+S*E,e[10]=v*i+w*h+x*u+S*A,e[11]=v*a+w*o+x*d+S*b,v=r[12],w=r[13],x=r[14],S=r[15],e[12]=v*n+w*c+x*m+S*g,e[13]=v*s+w*l+x*p+S*E,e[14]=v*i+w*h+x*u+S*A,e[15]=v*a+w*o+x*d+S*b,e};C.mul=C.multiply;C.translate=function(e,t,r){var n=r[0],s=r[1],i=r[2],a,c,l,h,o,m,p,u,d,g,E,A;return t===e?(e[12]=t[0]*n+t[4]*s+t[8]*i+t[12],e[13]=t[1]*n+t[5]*s+t[9]*i+t[13],e[14]=t[2]*n+t[6]*s+t[10]*i+t[14],e[15]=t[3]*n+t[7]*s+t[11]*i+t[15]):(a=t[0],c=t[1],l=t[2],h=t[3],o=t[4],m=t[5],p=t[6],u=t[7],d=t[8],g=t[9],E=t[10],A=t[11],e[0]=a,e[1]=c,e[2]=l,e[3]=h,e[4]=o,e[5]=m,e[6]=p,e[7]=u,e[8]=d,e[9]=g,e[10]=E,e[11]=A,e[12]=a*n+o*s+d*i+t[12],e[13]=c*n+m*s+g*i+t[13],e[14]=l*n+p*s+E*i+t[14],e[15]=h*n+u*s+A*i+t[15]),e};C.scale=function(e,t,r){var n=r[0],s=r[1],i=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e};C.rotate=function(e,t,r,n){var s=n[0],i=n[1],a=n[2],c=Math.sqrt(s*s+i*i+a*a),l,h,o,m,p,u,d,g,E,A,b,v,w,x,S,B,F,L,N,D,V,z,I,ie;return Math.abs(c)<K.EPSILON?null:(c=1/c,s*=c,i*=c,a*=c,l=Math.sin(r),h=Math.cos(r),o=1-h,m=t[0],p=t[1],u=t[2],d=t[3],g=t[4],E=t[5],A=t[6],b=t[7],v=t[8],w=t[9],x=t[10],S=t[11],B=s*s*o+h,F=i*s*o+a*l,L=a*s*o-i*l,N=s*i*o-a*l,D=i*i*o+h,V=a*i*o+s*l,z=s*a*o+i*l,I=i*a*o-s*l,ie=a*a*o+h,e[0]=m*B+g*F+v*L,e[1]=p*B+E*F+w*L,e[2]=u*B+A*F+x*L,e[3]=d*B+b*F+S*L,e[4]=m*N+g*D+v*V,e[5]=p*N+E*D+w*V,e[6]=u*N+A*D+x*V,e[7]=d*N+b*D+S*V,e[8]=m*z+g*I+v*ie,e[9]=p*z+E*I+w*ie,e[10]=u*z+A*I+x*ie,e[11]=d*z+b*I+S*ie,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)};C.rotateX=function(e,t,r){var n=Math.sin(r),s=Math.cos(r),i=t[4],a=t[5],c=t[6],l=t[7],h=t[8],o=t[9],m=t[10],p=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=i*s+h*n,e[5]=a*s+o*n,e[6]=c*s+m*n,e[7]=l*s+p*n,e[8]=h*s-i*n,e[9]=o*s-a*n,e[10]=m*s-c*n,e[11]=p*s-l*n,e};C.rotateY=function(e,t,r){var n=Math.sin(r),s=Math.cos(r),i=t[0],a=t[1],c=t[2],l=t[3],h=t[8],o=t[9],m=t[10],p=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=i*s-h*n,e[1]=a*s-o*n,e[2]=c*s-m*n,e[3]=l*s-p*n,e[8]=i*n+h*s,e[9]=a*n+o*s,e[10]=c*n+m*s,e[11]=l*n+p*s,e};C.rotateZ=function(e,t,r){var n=Math.sin(r),s=Math.cos(r),i=t[0],a=t[1],c=t[2],l=t[3],h=t[4],o=t[5],m=t[6],p=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=i*s+h*n,e[1]=a*s+o*n,e[2]=c*s+m*n,e[3]=l*s+p*n,e[4]=h*s-i*n,e[5]=o*s-a*n,e[6]=m*s-c*n,e[7]=p*s-l*n,e};C.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e};C.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.fromRotation=function(e,t,r){var n=r[0],s=r[1],i=r[2],a=Math.sqrt(n*n+s*s+i*i),c,l,h;return Math.abs(a)<K.EPSILON?null:(a=1/a,n*=a,s*=a,i*=a,c=Math.sin(t),l=Math.cos(t),h=1-l,e[0]=n*n*h+l,e[1]=s*n*h+i*c,e[2]=i*n*h-s*c,e[3]=0,e[4]=n*s*h-i*c,e[5]=s*s*h+l,e[6]=i*s*h+n*c,e[7]=0,e[8]=n*i*h+s*c,e[9]=s*i*h-n*c,e[10]=i*i*h+l,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)};C.fromXRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.fromYRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.fromZRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.fromRotationTranslation=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=n+n,l=s+s,h=i+i,o=n*c,m=n*l,p=n*h,u=s*l,d=s*h,g=i*h,E=a*c,A=a*l,b=a*h;return e[0]=1-(u+g),e[1]=m+b,e[2]=p-A,e[3]=0,e[4]=m-b,e[5]=1-(o+g),e[6]=d+E,e[7]=0,e[8]=p+A,e[9]=d-E,e[10]=1-(o+u),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e};C.fromRotationTranslationScale=function(e,t,r,n){var s=t[0],i=t[1],a=t[2],c=t[3],l=s+s,h=i+i,o=a+a,m=s*l,p=s*h,u=s*o,d=i*h,g=i*o,E=a*o,A=c*l,b=c*h,v=c*o,w=n[0],x=n[1],S=n[2];return e[0]=(1-(d+E))*w,e[1]=(p+v)*w,e[2]=(u-b)*w,e[3]=0,e[4]=(p-v)*x,e[5]=(1-(m+E))*x,e[6]=(g+A)*x,e[7]=0,e[8]=(u+b)*S,e[9]=(g-A)*S,e[10]=(1-(m+d))*S,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e};C.fromRotationTranslationScaleOrigin=function(e,t,r,n,s){var i=t[0],a=t[1],c=t[2],l=t[3],h=i+i,o=a+a,m=c+c,p=i*h,u=i*o,d=i*m,g=a*o,E=a*m,A=c*m,b=l*h,v=l*o,w=l*m,x=n[0],S=n[1],B=n[2],F=s[0],L=s[1],N=s[2];return e[0]=(1-(g+A))*x,e[1]=(u+w)*x,e[2]=(d-v)*x,e[3]=0,e[4]=(u-w)*S,e[5]=(1-(p+A))*S,e[6]=(E+b)*S,e[7]=0,e[8]=(d+v)*B,e[9]=(E-b)*B,e[10]=(1-(p+g))*B,e[11]=0,e[12]=r[0]+F-(e[0]*F+e[4]*L+e[8]*N),e[13]=r[1]+L-(e[1]*F+e[5]*L+e[9]*N),e[14]=r[2]+N-(e[2]*F+e[6]*L+e[10]*N),e[15]=1,e};C.fromQuat=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=r+r,c=n+n,l=s+s,h=r*a,o=n*a,m=n*c,p=s*a,u=s*c,d=s*l,g=i*a,E=i*c,A=i*l;return e[0]=1-m-d,e[1]=o+A,e[2]=p-E,e[3]=0,e[4]=o-A,e[5]=1-h-d,e[6]=u+g,e[7]=0,e[8]=p+E,e[9]=u-g,e[10]=1-h-m,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};C.frustum=function(e,t,r,n,s,i,a){var c=1/(r-t),l=1/(s-n),h=1/(i-a);return e[0]=i*2*c,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i*2*l,e[6]=0,e[7]=0,e[8]=(r+t)*c,e[9]=(s+n)*l,e[10]=(a+i)*h,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*i*2*h,e[15]=0,e};C.perspective=function(e,t,r,n,s){var i=1/Math.tan(t/2),a=1/(n-s);return e[0]=i/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(s+n)*a,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*s*n*a,e[15]=0,e};C.perspectiveFromFieldOfView=function(e,t,r,n){var s=Math.tan(t.upDegrees*Math.PI/180),i=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),c=Math.tan(t.rightDegrees*Math.PI/180),l=2/(a+c),h=2/(s+i);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=h,e[6]=0,e[7]=0,e[8]=-((a-c)*l*.5),e[9]=(s-i)*h*.5,e[10]=n/(r-n),e[11]=-1,e[12]=0,e[13]=0,e[14]=n*r/(r-n),e[15]=0,e};C.ortho=function(e,t,r,n,s,i,a){var c=1/(t-r),l=1/(n-s),h=1/(i-a);return e[0]=-2*c,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*h,e[11]=0,e[12]=(t+r)*c,e[13]=(s+n)*l,e[14]=(a+i)*h,e[15]=1,e};C.lookAt=function(e,t,r,n){var s,i,a,c,l,h,o,m,p,u,d=t[0],g=t[1],E=t[2],A=n[0],b=n[1],v=n[2],w=r[0],x=r[1],S=r[2];return Math.abs(d-w)<K.EPSILON&&Math.abs(g-x)<K.EPSILON&&Math.abs(E-S)<K.EPSILON?C.identity(e):(o=d-w,m=g-x,p=E-S,u=1/Math.sqrt(o*o+m*m+p*p),o*=u,m*=u,p*=u,s=b*p-v*m,i=v*o-A*p,a=A*m-b*o,u=Math.sqrt(s*s+i*i+a*a),u?(u=1/u,s*=u,i*=u,a*=u):(s=0,i=0,a=0),c=m*a-p*i,l=p*s-o*a,h=o*i-m*s,u=Math.sqrt(c*c+l*l+h*h),u?(u=1/u,c*=u,l*=u,h*=u):(c=0,l=0,h=0),e[0]=s,e[1]=c,e[2]=o,e[3]=0,e[4]=i,e[5]=l,e[6]=m,e[7]=0,e[8]=a,e[9]=h,e[10]=p,e[11]=0,e[12]=-(s*d+i*g+a*E),e[13]=-(c*d+l*g+h*E),e[14]=-(o*d+m*g+p*E),e[15]=1,e)};C.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"};C.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))};var jt=C,he=J,_={};_.create=function(){var e=new he.ARRAY_TYPE(3);return e[0]=0,e[1]=0,e[2]=0,e};_.clone=function(e){var t=new he.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t};_.fromValues=function(e,t,r){var n=new he.ARRAY_TYPE(3);return n[0]=e,n[1]=t,n[2]=r,n};_.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e};_.set=function(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e};_.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e};_.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e};_.sub=_.subtract;_.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e};_.mul=_.multiply;_.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e};_.div=_.divide;_.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e};_.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e};_.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e};_.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e};_.distance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(r*r+n*n+s*s)};_.dist=_.distance;_.squaredDistance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],s=t[2]-e[2];return r*r+n*n+s*s};_.sqrDist=_.squaredDistance;_.length=function(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)};_.len=_.length;_.squaredLength=function(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n};_.sqrLen=_.squaredLength;_.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e};_.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e};_.normalize=function(e,t){var r=t[0],n=t[1],s=t[2],i=r*r+n*n+s*s;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i),e};_.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};_.cross=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=r[0],c=r[1],l=r[2];return e[0]=s*l-i*c,e[1]=i*a-n*l,e[2]=n*c-s*a,e};_.lerp=function(e,t,r,n){var s=t[0],i=t[1],a=t[2];return e[0]=s+n*(r[0]-s),e[1]=i+n*(r[1]-i),e[2]=a+n*(r[2]-a),e};_.hermite=function(e,t,r,n,s,i){var a=i*i,c=a*(2*i-3)+1,l=a*(i-2)+i,h=a*(i-1),o=a*(3-2*i);return e[0]=t[0]*c+r[0]*l+n[0]*h+s[0]*o,e[1]=t[1]*c+r[1]*l+n[1]*h+s[1]*o,e[2]=t[2]*c+r[2]*l+n[2]*h+s[2]*o,e};_.bezier=function(e,t,r,n,s,i){var a=1-i,c=a*a,l=i*i,h=c*a,o=3*i*c,m=3*l*a,p=l*i;return e[0]=t[0]*h+r[0]*o+n[0]*m+s[0]*p,e[1]=t[1]*h+r[1]*o+n[1]*m+s[1]*p,e[2]=t[2]*h+r[2]*o+n[2]*m+s[2]*p,e};_.random=function(e,t){t=t||1;var r=he.RANDOM()*2*Math.PI,n=he.RANDOM()*2-1,s=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*s,e[1]=Math.sin(r)*s,e[2]=n*t,e};_.transformMat4=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=r[3]*n+r[7]*s+r[11]*i+r[15];return a=a||1,e[0]=(r[0]*n+r[4]*s+r[8]*i+r[12])/a,e[1]=(r[1]*n+r[5]*s+r[9]*i+r[13])/a,e[2]=(r[2]*n+r[6]*s+r[10]*i+r[14])/a,e};_.transformMat3=function(e,t,r){var n=t[0],s=t[1],i=t[2];return e[0]=n*r[0]+s*r[3]+i*r[6],e[1]=n*r[1]+s*r[4]+i*r[7],e[2]=n*r[2]+s*r[5]+i*r[8],e};_.transformQuat=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=r[0],c=r[1],l=r[2],h=r[3],o=h*n+c*i-l*s,m=h*s+l*n-a*i,p=h*i+a*s-c*n,u=-a*n-c*s-l*i;return e[0]=o*h+u*-a+m*-l-p*-c,e[1]=m*h+u*-c+p*-a-o*-l,e[2]=p*h+u*-l+o*-c-m*-a,e};_.rotateX=function(e,t,r,n){var s=[],i=[];return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],i[0]=s[0],i[1]=s[1]*Math.cos(n)-s[2]*Math.sin(n),i[2]=s[1]*Math.sin(n)+s[2]*Math.cos(n),e[0]=i[0]+r[0],e[1]=i[1]+r[1],e[2]=i[2]+r[2],e};_.rotateY=function(e,t,r,n){var s=[],i=[];return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],i[0]=s[2]*Math.sin(n)+s[0]*Math.cos(n),i[1]=s[1],i[2]=s[2]*Math.cos(n)-s[0]*Math.sin(n),e[0]=i[0]+r[0],e[1]=i[1]+r[1],e[2]=i[2]+r[2],e};_.rotateZ=function(e,t,r,n){var s=[],i=[];return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],i[0]=s[0]*Math.cos(n)-s[1]*Math.sin(n),i[1]=s[0]*Math.sin(n)+s[1]*Math.cos(n),i[2]=s[2],e[0]=i[0]+r[0],e[1]=i[1]+r[1],e[2]=i[2]+r[2],e};_.forEach=function(){var e=_.create();return function(t,r,n,s,i,a){var c,l;for(r||(r=3),n||(n=0),s?l=Math.min(s*r+n,t.length):l=t.length,c=n;c<l;c+=r)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],i(e,e,a),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2];return t}}();_.angle=function(e,t){var r=_.fromValues(e[0],e[1],e[2]),n=_.fromValues(t[0],t[1],t[2]);_.normalize(r,r),_.normalize(n,n);var s=_.dot(r,n);return s>1?0:Math.acos(s)};_.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"};var Jt=_,Z=J,T={};T.create=function(){var e=new Z.ARRAY_TYPE(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e};T.clone=function(e){var t=new Z.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};T.fromValues=function(e,t,r,n){var s=new Z.ARRAY_TYPE(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=n,s};T.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e};T.set=function(e,t,r,n,s){return e[0]=t,e[1]=r,e[2]=n,e[3]=s,e};T.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e};T.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e};T.sub=T.subtract;T.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e};T.mul=T.multiply;T.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e};T.div=T.divide;T.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e};T.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e};T.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e};T.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e};T.distance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],s=t[2]-e[2],i=t[3]-e[3];return Math.sqrt(r*r+n*n+s*s+i*i)};T.dist=T.distance;T.squaredDistance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],s=t[2]-e[2],i=t[3]-e[3];return r*r+n*n+s*s+i*i};T.sqrDist=T.squaredDistance;T.length=function(e){var t=e[0],r=e[1],n=e[2],s=e[3];return Math.sqrt(t*t+r*r+n*n+s*s)};T.len=T.length;T.squaredLength=function(e){var t=e[0],r=e[1],n=e[2],s=e[3];return t*t+r*r+n*n+s*s};T.sqrLen=T.squaredLength;T.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e};T.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e};T.normalize=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=r*r+n*n+s*s+i*i;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=n*a,e[2]=s*a,e[3]=i*a),e};T.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]};T.lerp=function(e,t,r,n){var s=t[0],i=t[1],a=t[2],c=t[3];return e[0]=s+n*(r[0]-s),e[1]=i+n*(r[1]-i),e[2]=a+n*(r[2]-a),e[3]=c+n*(r[3]-c),e};T.random=function(e,t){return t=t||1,e[0]=Z.RANDOM(),e[1]=Z.RANDOM(),e[2]=Z.RANDOM(),e[3]=Z.RANDOM(),T.normalize(e,e),T.scale(e,e,t),e};T.transformMat4=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3];return e[0]=r[0]*n+r[4]*s+r[8]*i+r[12]*a,e[1]=r[1]*n+r[5]*s+r[9]*i+r[13]*a,e[2]=r[2]*n+r[6]*s+r[10]*i+r[14]*a,e[3]=r[3]*n+r[7]*s+r[11]*i+r[15]*a,e};T.transformQuat=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=r[0],c=r[1],l=r[2],h=r[3],o=h*n+c*i-l*s,m=h*s+l*n-a*i,p=h*i+a*s-c*n,u=-a*n-c*s-l*i;return e[0]=o*h+u*-a+m*-l-p*-c,e[1]=m*h+u*-c+p*-a-o*-l,e[2]=p*h+u*-l+o*-c-m*-a,e[3]=t[3],e};T.forEach=function(){var e=T.create();return function(t,r,n,s,i,a){var c,l;for(r||(r=4),n||(n=0),s?l=Math.min(s*r+n,t.length):l=t.length,c=n;c<l;c+=r)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],e[3]=t[c+3],i(e,e,a),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2],t[c+3]=e[3];return t}}();T.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"};var Zt=T,Kt=J,Qt=qt,W=Jt,$=Zt,R={};R.create=function(){var e=new Kt.ARRAY_TYPE(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};R.rotationTo=function(){var e=W.create(),t=W.fromValues(1,0,0),r=W.fromValues(0,1,0);return function(n,s,i){var a=W.dot(s,i);return a<-.999999?(W.cross(e,t,s),W.length(e)<1e-6&&W.cross(e,r,s),W.normalize(e,e),R.setAxisAngle(n,e,Math.PI),n):a>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(W.cross(e,s,i),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+a,R.normalize(n,n))}}();R.setAxes=function(){var e=Qt.create();return function(t,r,n,s){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=s[0],e[4]=s[1],e[7]=s[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],R.normalize(t,R.fromMat3(t,e))}}();R.clone=$.clone;R.fromValues=$.fromValues;R.copy=$.copy;R.set=$.set;R.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};R.setAxisAngle=function(e,t,r){r=r*.5;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e};R.add=$.add;R.multiply=function(e,t,r){var n=t[0],s=t[1],i=t[2],a=t[3],c=r[0],l=r[1],h=r[2],o=r[3];return e[0]=n*o+a*c+s*h-i*l,e[1]=s*o+a*l+i*c-n*h,e[2]=i*o+a*h+n*l-s*c,e[3]=a*o-n*c-s*l-i*h,e};R.mul=R.multiply;R.scale=$.scale;R.rotateX=function(e,t,r){r*=.5;var n=t[0],s=t[1],i=t[2],a=t[3],c=Math.sin(r),l=Math.cos(r);return e[0]=n*l+a*c,e[1]=s*l+i*c,e[2]=i*l-s*c,e[3]=a*l-n*c,e};R.rotateY=function(e,t,r){r*=.5;var n=t[0],s=t[1],i=t[2],a=t[3],c=Math.sin(r),l=Math.cos(r);return e[0]=n*l-i*c,e[1]=s*l+a*c,e[2]=i*l+n*c,e[3]=a*l-s*c,e};R.rotateZ=function(e,t,r){r*=.5;var n=t[0],s=t[1],i=t[2],a=t[3],c=Math.sin(r),l=Math.cos(r);return e[0]=n*l+s*c,e[1]=s*l-n*c,e[2]=i*l+a*c,e[3]=a*l-i*c,e};R.calculateW=function(e,t){var r=t[0],n=t[1],s=t[2];return e[0]=r,e[1]=n,e[2]=s,e[3]=Math.sqrt(Math.abs(1-r*r-n*n-s*s)),e};R.dot=$.dot;R.lerp=$.lerp;R.slerp=function(e,t,r,n){var s=t[0],i=t[1],a=t[2],c=t[3],l=r[0],h=r[1],o=r[2],m=r[3],p,u,d,g,E;return u=s*l+i*h+a*o+c*m,u<0&&(u=-u,l=-l,h=-h,o=-o,m=-m),1-u>1e-6?(p=Math.acos(u),d=Math.sin(p),g=Math.sin((1-n)*p)/d,E=Math.sin(n*p)/d):(g=1-n,E=n),e[0]=g*s+E*l,e[1]=g*i+E*h,e[2]=g*a+E*o,e[3]=g*c+E*m,e};R.sqlerp=function(){var e=R.create(),t=R.create();return function(r,n,s,i,a,c){return R.slerp(e,n,a,c),R.slerp(t,s,i,c),R.slerp(r,e,t,2*c*(1-c)),r}}();R.invert=function(e,t){var r=t[0],n=t[1],s=t[2],i=t[3],a=r*r+n*n+s*s+i*i,c=a?1/a:0;return e[0]=-r*c,e[1]=-n*c,e[2]=-s*c,e[3]=i*c,e};R.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e};R.length=$.length;R.len=R.length;R.squaredLength=$.squaredLength;R.sqrLen=R.squaredLength;R.normalize=$.normalize;R.fromMat3=function(e,t){var r=t[0]+t[4]+t[8],n;if(r>0)n=Math.sqrt(r+1),e[3]=.5*n,n=.5/n,e[0]=(t[5]-t[7])*n,e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var s=0;t[4]>t[0]&&(s=1),t[8]>t[s*3+s]&&(s=2);var i=(s+1)%3,a=(s+2)%3;n=Math.sqrt(t[s*3+s]-t[i*3+i]-t[a*3+a]+1),e[s]=.5*n,n=.5/n,e[3]=(t[i*3+a]-t[a*3+i])*n,e[i]=(t[i*3+s]+t[s*3+i])*n,e[a]=(t[a*3+s]+t[s*3+a])*n}return e};R.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"};var er=R,pe=J,M={};M.create=function(){var e=new pe.ARRAY_TYPE(2);return e[0]=0,e[1]=0,e};M.clone=function(e){var t=new pe.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t};M.fromValues=function(e,t){var r=new pe.ARRAY_TYPE(2);return r[0]=e,r[1]=t,r};M.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e};M.set=function(e,t,r){return e[0]=t,e[1]=r,e};M.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e};M.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e};M.sub=M.subtract;M.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e};M.mul=M.multiply;M.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e};M.div=M.divide;M.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e};M.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e};M.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e};M.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e};M.distance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(r*r+n*n)};M.dist=M.distance;M.squaredDistance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1];return r*r+n*n};M.sqrDist=M.squaredDistance;M.length=function(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)};M.len=M.length;M.squaredLength=function(e){var t=e[0],r=e[1];return t*t+r*r};M.sqrLen=M.squaredLength;M.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e};M.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e};M.normalize=function(e,t){var r=t[0],n=t[1],s=r*r+n*n;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s),e};M.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]};M.cross=function(e,t,r){var n=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=n,e};M.lerp=function(e,t,r,n){var s=t[0],i=t[1];return e[0]=s+n*(r[0]-s),e[1]=i+n*(r[1]-i),e};M.random=function(e,t){t=t||1;var r=pe.RANDOM()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e};M.transformMat2=function(e,t,r){var n=t[0],s=t[1];return e[0]=r[0]*n+r[2]*s,e[1]=r[1]*n+r[3]*s,e};M.transformMat2d=function(e,t,r){var n=t[0],s=t[1];return e[0]=r[0]*n+r[2]*s+r[4],e[1]=r[1]*n+r[3]*s+r[5],e};M.transformMat3=function(e,t,r){var n=t[0],s=t[1];return e[0]=r[0]*n+r[3]*s+r[6],e[1]=r[1]*n+r[4]*s+r[7],e};M.transformMat4=function(e,t,r){var n=t[0],s=t[1];return e[0]=r[0]*n+r[4]*s+r[12],e[1]=r[1]*n+r[5]*s+r[13],e};M.forEach=function(){var e=M.create();return function(t,r,n,s,i,a){var c,l;for(r||(r=2),n||(n=0),s?l=Math.min(s*r+n,t.length):l=t.length,c=n;c<l;c+=r)e[0]=t[c],e[1]=t[c+1],i(e,e,a),t[c]=e[0],t[c+1]=e[1];return t}}();M.str=function(e){return"vec2("+e[0]+", "+e[1]+")"};var le=jt,qe=er;function tr(e,t,r,n,s,i,a){const c=t*t,l=t*c,h=2*l-3*c+1,o=r*(l-2*c+t),m=3*c-2*l,p=r*(l-c),u=n.length;for(let d=0;d<u;d++)e[d]=h*n[d]+o*s[d]+m*a[d]+p*i[d]}class rr{constructor(t){this.frame=0,this.t0=t.getRawScalar(0),this.t1=t.getRawScalar(1),this.inBound=!0,this._fMax=t.count-1}contain(t){return t<this.t0?-1:t>=this.t1?1:0}normalizedFrame(){return Math.min(Math.max(this.frame,0),this._fMax)}}class ve{constructor(t,r){this.sampler=t,this.interval=new rr(t.input),this.numElements=r}resolveInterval(t){const r=this.interval,n=this.sampler.input,s=n.count,i=r.contain(t);if(i===0)return;let a,c,l,h=!0;if(i>0){a=r.frame+1,c=r.t1;do a++,h=a<s,l=c,c=h?n.getRawScalar(a):Number.MAX_VALUE;while(c<=t);a--}else{a=r.frame,l=r.t0;do a--,h=a>=0,c=l,l=h?n.getRawScalar(a):-Number.MAX_VALUE;while(l>t)}r.frame=a,r.t0=l,r.t1=c,r.inBound=h}evaluate(t,r){}}class nr extends ve{evaluate(t,r){this.resolveInterval(r),this.sampler.output.getValues(t,this.interval.normalizedFrame()*this.numElements,this.numElements)}}function Ie(e,t,r,n){const s=t.length,i=1-n;for(let a=0;a<s;a++)e[a]=t[a]*i+r[a]*n}function sr(e,t,r,n){e[0]=t[0]*(1-n)+r[0]*n}function ir(e,t){switch(e){case y.AnimationChannelTargetPath.WEIGHTS:return t===1?sr:Ie;case y.AnimationChannelTargetPath.ROTATION:return qe.slerp;case y.AnimationChannelTargetPath.SCALE:case y.AnimationChannelTargetPath.TRANSLATION:default:return Ie}}class ar extends ve{constructor(t,r,n){super(t,n),this.val0=t.output.createElementHolderArray(n),this.val1=t.output.createElementHolderArray(n),this.lerpFunc=ir(r,this.val0.length)}evaluate(t,r){this.resolveInterval(r);const n=this.sampler.output,s=this.numElements;if(this.interval.inBound){const{t0:i,t1:a,frame:c}=this.interval,l=(r-i)/(a-i);n.getValues(this.val0,s*c+0,s),n.getValues(this.val1,s*c+s,s),this.lerpFunc(t,this.val0,this.val1,l)}else n.getValues(t,this.interval.normalizedFrame()*s,s)}}class cr extends ve{constructor(t,r,n){super(t,n),this.val0=t.output.createElementHolderArray(n),this.val1=t.output.createElementHolderArray(n),this.val2=t.output.createElementHolderArray(n),this.val3=t.output.createElementHolderArray(n),this.assumeQuat=r===y.AnimationChannelTargetPath.ROTATION}evaluate(t,r){this.resolveInterval(r);const n=this.sampler.output,s=this.numElements;if(this.interval.inBound){const{t0:i,t1:a,frame:c}=this.interval,l=a-i,h=(r-i)/l;n.getValues(this.val0,s*(c*3+1),s),n.getValues(this.val1,s*(c*3+2),s),n.getValues(this.val2,s*(c*3+3),s),n.getValues(this.val3,s*(c*3+4),s),tr(t,h,l,this.val0,this.val1,this.val2,this.val3),this.assumeQuat&&qe.normalize(t,t)}else n.getValues(t,s*(this.interval.normalizedFrame()*3+1),s)}}function lr(e,t,r){switch(e.interpolation){case y.AnimationSamplerInterpolation.STEP:return new nr(e,r);case y.AnimationSamplerInterpolation.LINEAR:return new ar(e,t,r);case y.AnimationSamplerInterpolation.CUBICSPLINE:return new cr(e,t,r);default:throw new Error("GLTF : Unsupported sampler interpolation "+e.interpolation)}}class hr{constructor(t,r,n){this.sampler=t,this.numElements=n,this.interpolator=lr(t,r,n)}evaluate(t,r){this.interpolator.evaluate(t,r)}createElementHolder(){return this.sampler.output.createElementHolderArray(this.numElements)}}class or{constructor(){this.gltftype=f.ANIMATION_SAMPLER,this.minTime=0,this.maxTime=0}async parse(t,r){this.input=await t.getElement(f.ACCESSOR,r.input),this.output=await t.getElement(f.ACCESSOR,r.output),this.interpolation=r.interpolation||y.AnimationSamplerInterpolation.LINEAR,this.minTime=this.input.getRawScalar(0),this.maxTime=this.input.getRawScalar(this.input.count-1)}createEvaluator(t,r){return new hr(this,t,r)}}var X;(function(e){e.float="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4"})(X||(X={}));const fr=e=>Math.max(e/127,-1),mr=e=>e/255,pr=e=>Math.max(e/32767,-1),ur=e=>e/65535,dr=e=>e,Er=e=>e;function gr(e){switch(e){case y.AccessorComponentType.BYTE:return fr;case y.AccessorComponentType.UNSIGNED_BYTE:return mr;case y.AccessorComponentType.SHORT:return pr;case y.AccessorComponentType.UNSIGNED_SHORT:return ur;case y.AccessorComponentType.UNSIGNED_INT:return dr;case y.AccessorComponentType.FLOAT:return Er}}function re(e){switch(e){case y.AccessorComponentType.BYTE:return Int8Array;case y.AccessorComponentType.UNSIGNED_BYTE:return Uint8Array;case y.AccessorComponentType.SHORT:return Int16Array;case y.AccessorComponentType.UNSIGNED_SHORT:return Uint16Array;case y.AccessorComponentType.UNSIGNED_INT:return Uint32Array;case y.AccessorComponentType.FLOAT:return Float32Array}}function Ar(e){return re(e).BYTES_PER_ELEMENT}function _r(e){switch(e){case y.AccessorType.SCALAR:return 1;case y.AccessorType.VEC2:return 2;case y.AccessorType.VEC3:return 3;case y.AccessorType.VEC4:return 4;case y.AccessorType.MAT2:return 4;case y.AccessorType.MAT3:return 9;case y.AccessorType.MAT4:return 16}}function wr(e){switch(e){case y.AccessorType.SCALAR:return X.float;case y.AccessorType.VEC2:return X.vec2;case y.AccessorType.VEC3:return X.vec3;case y.AccessorType.VEC4:return X.vec4;case y.AccessorType.MAT2:return X.mat2;case y.AccessorType.MAT3:return X.mat3;case y.AccessorType.MAT4:return X.mat4}}class ye{constructor(){this.normalized=!1,this.byteOffset=0,this.count=0,this._stride=0,this._strideElem=0}get numComps(){return _r(this.type)}get bytesPerElem(){return Ar(this.componentType)}get glslType(){return wr(this.type)}*[Symbol.iterator](){const t=this.createElementHolder();for(let r=0;r<this.count;r++)this.getValue(t,r),yield t}createElementHolder(t=this.normalized){return t?new Float32Array(this.numComps):new(re(this.componentType))(this.numComps)}createElementHolderArray(t,r=this.normalized){return r?new Float32Array(this.numComps*t):new(re(this.componentType))(this.numComps*t)}getScalar(t,r=this.normalized){let n;return this.sparse!==null?n=this.sparse.getRawScalar(t):n=this.getRawScalar(t),r&&(n=this._normalizeFunc(n)),n}getRawScalar(t){const r=this._strideElem*t;return this._array[r]}getValue(t,r,n=this.normalized){const s=n?this._valueHolder:t;this.sparse!==null?this.sparse.getRawValue(s,r):this.getRawValue(s,r),n&&this._normalize(t,s)}getValues(t,r,n){if(this.sparse!==null)throw new Error("Cant call getValues in sparsed accessor");this.getRawValues(t,r,n),this.normalized&&this._normalize(t,t)}getRawValue(t,r){const n=this._strideElem*r,s=this.numComps;for(let i=0;i<s;i++)t[i]=this._array[i+n]}getRawValues(t,r,n){const s=this.numComps;for(let i=0;i<n;i++){const a=i*s,c=this._strideElem*(r+i);for(let l=0;l<s;l++)t[a+l]=this._array[l+c]}}_normalize(t,r){const n=this._normalizeFunc,s=this.numComps;for(let i=0;i<s;i++)t[i]=n(r[i])}}class vr extends ye{constructor(){super(...arguments),this.gltftype=f.ACCESSOR}async parse(t,r){const{byteOffset:n=0,normalized:s=!1}=r;if(this.normalized=s,this.byteOffset=n,this.componentType=r.componentType,this.count=r.count,this.type=r.type,this.max=r.max,this.min=r.min,r.bufferView!==void 0){this.bufferView=await t.getElement(f.BUFFERVIEW,r.bufferView);const i=re(this.componentType);this.bufferView.byteStride===0?(this._stride=this.numComps*this.bytesPerElem,this._strideElem=this.numComps):(this._stride=this.bufferView.byteStride,this._strideElem=this._stride/i.BYTES_PER_ELEMENT,j.isTrue(this._strideElem===Math.round(this._strideElem)));const a=this.bufferView.buffer._bytes,c=this.byteOffset+this.bufferView.getByteOffset(),l=(a.byteLength-c)/i.BYTES_PER_ELEMENT,h=Math.min(this.count*this._strideElem,l);this._array=new i(a,c,h)}else this.bufferView=null,this._stride=0,this._strideElem=0,this._array=this.createElementHolder();return this.sparse=null,r.sparse!==void 0&&t._loadElement(r.sparse).then(i=>this.sparse=i),this._valueHolder=this.createElementHolder(),this._normalizeFunc=gr(this.componentType),Promise.resolve()}}class yr{constructor(){this.gltftype=f.CAMERA}parse(t,r){switch(this.type=r.type,this.type){case y.CameraType.PERSPECTIVE:this.projectionData=r.perspective,this.lens=this.createPerpective(this.projectionData);break;case y.CameraType.ORTHOGRAPHIC:this.projectionData=r.orthographic,this.lens=this.createOrtho(this.projectionData);break;default:throw new Error("Camera - unsupported type "+this.type)}return Promise.resolve()}createPerpective(t){var r,n;const s=new Ke;return s.near=t.znear,s.far=(r=t.zfar)!==null&&r!==void 0?r:100,s.setVerticalFov(t.yfov),s.aspect=(n=t.aspectRatio)!==null&&n!==void 0?n:1,s}createOrtho(t){const r=new Qe;return r.near=t.znear,r.far=t.zfar,r._xMin=-t.xmag,r._xMax=t.xmag,r._yMin=-t.ymag,r._yMax=t.ymag,r}}function Sr(e){for(let t=0;t<e.length;t++)if(e[t]!==1)return!1;return!0}function xr(e){for(let t=0;t<e.length;t++)if(e[t]!==0)return!1;return!0}class je{async parse(t,r){var n,s;this.baseColorFactor=new Float32Array(r.baseColorFactor||[1,1,1,1]),this.metallicFactor=(n=r.metallicFactor)!==null&&n!==void 0?n:1,this.roughnessFactor=(s=r.roughnessFactor)!==null&&s!==void 0?s:1,r.baseColorTexture!==void 0&&(this.baseColorTexture=await t._loadElement(r.baseColorTexture)),r.metallicRoughnessTexture!==void 0&&(this.metallicRoughnessTexture=await t._loadElement(r.metallicRoughnessTexture))}setupPass(t){const r=new Ye;if(t.setSurface(r),this.baseColorTexture){const n=this.baseColorTexture.createSampler("basecolor");n.colorspace=Te.SRGB,r.baseColor.attach(n,"rgb"),t.alpha.attach(n,"a")}if(!Sr(this.baseColorFactor)){const n=new at("uBasecolorFactor",4);n.set(...this.baseColorFactor),r.baseColorFactor.attach(n,"rgb"),t.alphaFactor.attach(n,"a")}if(this.metallicRoughnessTexture){const n=this.metallicRoughnessTexture.createSampler("metalRough");n.colorspace=Te.LINEAR,r.metalness.attach(n,"b"),r.roughness.attach(n,"g")}this.metallicFactor!==1&&r.metalnessFactor.attachUniform("uMetalnessFactor").set(this.metallicFactor),this.roughnessFactor!==1&&r.roughnessFactor.attachUniform("uRoughnessFactor").set(this.roughnessFactor)}}const Tr=770,Mr=771;class Rr{constructor(){this.gltftype=f.MATERIAL}get materialPass(){return this._materialPass}createMaterialForPrimitive(t,r,n){const s=t.gl;this._materialPass.version.set(pt(s)?"300 es":"100");const i=new ct(s,this._materialPass.name);i.addPass(this._materialPass,"color");const a=n.attributes.getSemantic("NORMAL"),c=n.attributes.getSemantic("TANGENT");i.inputs.add(new Me("hasNormals",a!==null)),i.inputs.add(new Me("hasTangents",c!==null));const l=n.attributes.getSemantic("COLOR_0");if(l!==null){const h=new lt("vertexColor",3);h.attachAttribute(l.glslname),i.inputs.add(h)}return i.addPass(t.depthPass,"depth"),i}async parse(t,r){var n,s;this.emissiveFactor=new Float32Array(r.emissiveFactor||[0,0,0]),this.alphaMode=r.alphaMode||y.MaterialAlphaMode.OPAQUE,this.alphaCutoff=(n=r.alphaCutoff)!==null&&n!==void 0?n:.5,this.doubleSided=(s=r.doubleSided)!==null&&s!==void 0?s:!1,await this.parsePbrInputsData(t,r),r.normalTexture!==void 0&&(this.normalTexture=await t._loadElement(r.normalTexture)),r.occlusionTexture!==void 0&&(this.occlusionTexture=await t._loadElement(r.occlusionTexture)),r.emissiveTexture!==void 0&&(this.emissiveTexture=await t._loadElement(r.emissiveTexture)),this.name=r.name,this.setupMaterials()}async parsePbrInputsData(t,r){r.pbrMetallicRoughness!==void 0&&(this.pbrInputsData=this.pbrMetallicRoughness=new je,await this.pbrMetallicRoughness.parse(t,r.pbrMetallicRoughness))}configurePbrSurface(t){this.pbrInputsData!==void 0?this.pbrInputsData.setupPass(t):t.setSurface(new Ye)}configureAlpha(t){this.alphaMode===y.MaterialAlphaMode.BLEND?(t.glconfig.depthMask(!1),t.glconfig.enableBlend(),t.glconfig.blendFunc(Tr,Mr),t.mask=H.getRenderConfig().blendedMask):t.mask=H.getRenderConfig().opaqueMask,t.alphaMode.set(this.alphaMode),this.alphaMode===y.MaterialAlphaMode.MASK&&t.alphaCutoff.attachUniform("uAlphaCutoff").set(this.alphaCutoff)}}class Ir extends Rr{setupMaterials(){const t=new mt(this.name);if(t.glconfig.enableDepthTest(),t.glconfig.enableCullface(!this.doubleSided),t.doubleSided.set(this.doubleSided),this.configureAlpha(t),this.configurePbrSurface(t),this.emissiveTexture){const s=this.emissiveTexture.createSampler("emissive");t.emissive.attach(s)}xr(this.emissiveFactor)||t.emissiveFactor.attachUniform("uEmissFactor").set(...this.emissiveFactor);const r=this.normalTexture;if(r){const s=r.createSampler("nrmmap");t.normal.attach(s),r.scale!==1&&t.normalScale.attachUniform("uNormalScale").set(r.scale)}const n=this.occlusionTexture;if(n){const s=n.createSampler("occlu");t.occlusion.attach(s),n.strength!==1&&t.occlusionStrength.attachUniform("uOccluStrength").set(n.strength)}this._materialPass=t}}class br{constructor(){this.gltftype=f.MESH}async parse(t,r){const n=r.primitives.map(s=>t._loadElement(s));this.primitives=await Promise.all(n),r.weights&&(this.weights=new Float32Array(r.weights))}}class Se{constructor(){this._sampler=null}createSampler(t){var r;if(this._sampler===null){const n=H.getSemantics().getAttributeName(`TEXCOORD_${this.texCoord}`);this._sampler=new ht(`tex_${(r=this.name)!==null&&r!==void 0?r:""}${t}`,ot.create(n)),this.texture.glTexturePromise.then(s=>this._sampler.set(s))}return this._sampler}async parse(t,r){var n;this.texture=await t.getElement(f.TEXTURE,r.index),this.texCoord=(n=r.texCoord)!==null&&n!==void 0?n:0}}class Cr extends Se{constructor(){super(...arguments),this.gltftype=f.TEXTURE_INFO}}class Nr extends Se{constructor(){super(...arguments),this.gltftype=f.NORMAL_TEXTURE_INFO}async parse(t,r){var n;await super.parse(t,r),this.scale=(n=r.scale)!==null&&n!==void 0?n:1}}class Pr extends Se{constructor(){super(...arguments),this.gltftype=f.OCCLUSION_TEXTURE_INFO}async parse(t,r){var n;await super.parse(t,r),this.strength=(n=r.strength)!==null&&n!==void 0?n:1}}function Or(e,t){e.createVertexArray=function(){return t.createVertexArrayOES()},e.bindVertexArray=function(r){return t.bindVertexArrayOES(r)},e.deleteVertexArray=function(r){return t.deleteVertexArrayOES(r)},e.isVertexArray=function(r){return t.isVertexArrayOES(r)}}function Fr(e){return e.bindVertexArray!==void 0}class Lr{constructor(t){if(this.gl=t,Fr(t))this._impl=new be(this);else{const r=t.getExtension("OES_vertex_array_object");r?(Or(t,r),this._impl=new be(this)):this._impl=new Br(this)}}dispose(){this._impl.dispose()}setup(t,r,n){t.ready||t._grabParameters(),this._impl.setup(t,r,n)}bind(){this._impl.bind()}unbind(){this._impl.unbind()}}class be{constructor(t){this._vao=t,this._gl=this._vao.gl,this._handle=null}dispose(){this.release()}setup(t,r,n){this.release();const s=this._gl;this._handle=s.createVertexArray(),s.bindVertexArray(this._handle);for(var i=0;i<r.length;i++)r[i].attribPointer(t);n!==void 0&&n.bind(),s.bindVertexArray(null)}bind(){this._gl.bindVertexArray(this._handle)}unbind(){this._gl.bindVertexArray(null)}release(){this._handle&&(this._gl.deleteVertexArray(this._handle),this._handle=null)}}class Br{constructor(t){this._vao=t,this.prg=null,this.buffers=null,this.indices=null}dispose(){this.prg=null,this.buffers=null,this.indices=null}setup(t,r,n){this.prg=t,this.buffers=r,this.indices=n}bind(){if(!(this.buffers==null||this.prg==null||this.indices==null)){for(var t=0;t<this.buffers.length;t++)this.buffers[t].attribPointer(this.prg);this.indices!==void 0&&this.indices.bind()}}unbind(){}}class Ce{constructor(t,r){this.semantic=t,this.accessor=r,this.glslname=H.getSemantics().getAttributeName(t)}}class Vr{constructor(t){this.accessor=t,this.attributes=[]}addAttribute(t){this.attributes.push(t)}}class Ne{constructor(){this._attributes=[]}get length(){return this._attributes.length}get attributes(){return this._attributes}add(t){this._attributes.push(t)}getSemantic(t){for(const r of this._attributes)if(r.semantic===t)return r;return null}getBuffersViewSets(){const t=new Map;for(const r of this._attributes){const n=r.accessor.bufferView;t.has(n)||t.set(n,new Vr(r.accessor)),t.get(n).addAttribute(r)}return Array.from(t.values())}}const Ur=34963,Dr=34962;class zr{constructor(){this.gltftype=f.PRIMITIVE,this.material=null,this.indices=null,this.targets=null,this.bounds=new Ee}_calculaterBounds(){const t=this.attributes.getSemantic("POSITION");t!=null&&t.accessor.min&&t.accessor.max&&this.bounds.fromMinMax(t.accessor.min,t.accessor.max)}async parse(t,r){if(this.attributes=new Ne,await this.parseAttributeSet(t,this.attributes,r.attributes),r.indices!==void 0&&(this.indices=await t.getElement(f.ACCESSOR,r.indices)),r.material!==void 0?this.material=await t.getElement(f.MATERIAL,r.material):this.material=await t.loadDefaultMaterial(),r.mode!==void 0?this.mode=r.mode:this.mode=y.MeshPrimitiveMode.DEFAULT,r.targets!==void 0){this.targets=[];for(let n=0;n<r.targets.length;n++){const s=r.targets[n],i=new Ne;await this.parseMorphAttributeSet(t,i,s,n),this.targets.push(i)}}this._calculaterBounds()}async parseAttributeSet(t,r,n){for(const s in n){const i=await t.getElement(f.ACCESSOR,n[s]);r.add(new Ce(s,i))}}async parseMorphAttributeSet(t,r,n,s){for(const i in n){const a=await t.getElement(f.ACCESSOR,n[i]),c=new Ce(i,a);c.glslname=H.getSemantics().getMorphedAttributeName(c.semantic,s),r.add(c)}}allocateGl(t){this._vaoMap=new Map,this.buffers=[];const r=this.attributes.getBuffersViewSets();for(const n of r)this.buffers.push(this.createArrayBuffer(t,n));if(this.indices!==null){const n=this.indices.bufferView.getWebGLBuffer(t,Ur);this.indexBuffer=new dt(t,this.indices.componentType,void 0,t.STATIC_DRAW,n),this.indexBuffer.byteLength=this.indices.bufferView.byteLength}if(this.targets!==null)for(let n=0;n<this.targets.length;n++){const i=this.targets[n].getBuffersViewSets();for(const a of i)this.buffers.push(this.createArrayBuffer(t,a))}}createArrayBuffer(t,r){const n=r.accessor.bufferView,s=n.getWebGLBuffer(t,Dr),i=new ut(t,void 0,t.STATIC_DRAW,s);i.byteLength=n.byteLength,i.stride=r.accessor._stride,i._computeLength();for(const a of r.attributes){const c=this.createAttributeDefinition(a);i.attribs.push(c)}return i}createAttributeDefinition(t){const r=t.accessor;return{name:t.glslname,type:r.componentType,size:r.numComps,normalize:r.normalized,offset:r.byteOffset,stride:r._stride}}getVao(t){const r=t._cuid.toString();if(!this._vaoMap.has(r)){const n=new Lr(t.gl);n.setup(t,this.buffers,this.indexBuffer),this._vaoMap.set(r,n)}return this._vaoMap.get(r)}bindVao(t){this._currentVao=this.getVao(t),this._currentVao.bind()}render(){this.indexBuffer?this.indexBuffer.draw(this.mode,this.indices.count,this.indices.byteOffset):this.buffers[0].draw(this.mode)}unbindVao(){this._currentVao.unbind()}}const Pe=10497;class Gr{constructor(){this.gltftype=f.SAMPLER}parse(t,r){var n,s;return this.magFilter=r.magFilter,this.minFilter=r.minFilter,this.wrapS=(n=r.wrapS)!==null&&n!==void 0?n:Pe,this.wrapT=(s=r.wrapT)!==null&&s!==void 0?s:Pe,Promise.resolve()}}class Hr{constructor(){this.gltftype=f.SCENE}async parse(t,r){if(r.nodes!==void 0){const n=r.nodes.map(s=>t.getElement(f.NODE,s));this.nodes=await Promise.all(n)}else this.nodes=[]}updateNodes(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].updateWorldMatrix()}}const Oe=le.create();class Yr{constructor(){this.gltftype=f.SKIN}async parse(t,r){const n=r.joints.map(s=>t.getElement(f.NODE,s));if(this.joints=await Promise.all(n),this.inverseBindMatrices=this.joints.map(le.create),r.inverseBindMatrices!==void 0){const s=await t.getElement(f.ACCESSOR,r.inverseBindMatrices);this.inverseBindMatrices.forEach((i,a)=>s.getValue(i,a))}r.skeleton!==void 0&&(this.skeletonRoot=await t.getElement(f.NODE,r.skeleton))}computeJoints(t,r){if(r.length!==this.joints.length)throw new Error("Skin.computeJoints(), jointMatrices size must match joints size");le.invert(Oe,t._wmatrix);for(let n=0;n<this.joints.length;n++){const s=this.joints[n],i=this.inverseBindMatrices[n],a=r[n];le.mul(a,s._wmatrix,i),le.mul(a,Oe,a)}}}class $r{constructor(){this.resolve=t=>{this._resolve(t)},this.reject=t=>{this._reject(t)},this.promise=new Promise((t,r)=>{this._resolve=t,this._reject=r})}}class kr{constructor(){this.gltftype=f.TEXTURE,this._glTextureDeferred=new $r}get glTexturePromise(){return this._glTextureDeferred.promise}async parse(t,r){r.sampler!==void 0&&(this.sampler=await t.getElement(f.SAMPLER,r.sampler)),r.source!==void 0&&(this.source=await t.getElement(f.IMAGE,r.source)),this._defaultTextureFilter=t.defaultTextureFilter}async allocateGl(t){var r,n;let s=t.RGB;this.source.hasAlpha&&(s=t.RGBA);let i=this._defaultTextureFilter,a=t.LINEAR,c=t.REPEAT,l=t.REPEAT;this.sampler&&(i=(r=this.sampler.minFilter)!==null&&r!==void 0?r:i,a=(n=this.sampler.magFilter)!==null&&n!==void 0?n:t.LINEAR,c=this.sampler.wrapS,l=this.sampler.wrapT),this.glTexture=new gt(t,s,t.UNSIGNED_BYTE),await this.source.setupTexture(this.glTexture,c,l,i,a),this.glTexture.bind(),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,l),t.bindTexture(t.TEXTURE_2D,null),this._glTextureDeferred.resolve(this.glTexture)}}const xe="uMorphWeights";function Wr(e){return e.attributes.map((t,r)=>`IN ${e.type} ${t};`).join(`
`)}function Xr(e){const t=e.attributes.map((r,n)=>`${r} * ${xe}[${n}]`).join(` +
 `);return`void MorphAttribute_${e.name}( inout ${e.type} ${e.name} ){
    ${e.name} += ${t};
  }`}function qr(e){return`MorphAttribute_${e.name}( vertex.${e.name} );`}function jr(e){return e.map(Wr).join(`
`)}function Jr(e){return e.map(Xr).join(`
`)}function Zr(e){return e.map(qr).join(`
`)}function Kr(e){return`uniform float ${xe}[${e}];`}const Fe={preVertexCode(e){return[Kr(e.numTargets),jr(e.morphInfos),Jr(e.morphInfos)].join(`
`)},vertexCode(e){return Zr(e.morphInfos)}};function Qr(e){const t=e[0].attributes.length;for(let r=1;r<e.length;r++)if(e[r].attributes.length!==t)throw new Error("MorphDeformer mutiple morph dont have the same size")}class en extends He{constructor(t){super(!0,!0),this._morphInfos=[],Qr(t),this._morphInfos=t,this._weights=new Float32Array(this.numTargets)}get weights(){return this._weights}set weights(t){if(t.length!==this.numTargets)throw new Error("MorphDeformer weights length and numMorph must match");this._weights=t}get numTargets(){return this._morphInfos[0].attributes.length}get morphInfos(){return this._morphInfos}setup(t){t[xe](this._weights)}_genCode(t){t.add("pv",Fe.preVertexCode(this)),t.add("vertex_warp",Fe.vertexCode(this))}_getHash(){return"mrph"}}var ne=function(e){var t="";return t+="",e.pv===!0&&(t+=`

#define SKIN_NUM_JOINTS `+e.numJoints+`
uniform mat4 uJoints[SKIN_NUM_JOINTS];
`+e.attribDecl+`
mat4 ComputeSkinMatrix() {
  mat4 SM = `+e.matrixSum+`;
  return SM;
}
`),t+=`

`,e.vertex_warp===!0&&(t+=`
  mat4 _skinMatrix = ComputeSkinMatrix();
  vertex.worldMatrix = vertex.worldMatrix * _skinMatrix;
`),t+=`
`,t};ne.toString=ne;var Le=ne;ne._hmrListeners=[];ne.onHmr=function(e){this._hmrListeners.push(e)};ne._triggerHmr=function(){for(const e of this._hmrListeners)e(this)};const tn=["x","y","z","w"],Je="uJoints";function rn(e){return e===1?"float":`vec${e}`}function nn(e){let t="";for(const r of e){const n=rn(r.numComponents);t+=`
IN ${n} ${r.jointsAttrib}; 
IN ${n} ${r.weightsAttrib};`}return t}function sn(e){const t=[];for(const r of e){const n=r.numComponents;for(let s=0;s<n;s++){const i=n===1?"":"."+tn[s],a=r.jointsAttrib+i,c=r.weightsAttrib+i;t.push(`${Je}[int(${a})] * ${c}`)}}return t.join(`+ 
  `)}const Be={preVertexCode(e){return Le({pv:!0,numJoints:e._numJoints,attribDecl:nn(e._attributeSets),matrixSum:sn(e._attributeSets)})},vertexCode(){return Le({vertex_warp:!0})}};class an extends He{constructor(t,r){super(!0,!0),this._attributeSets=r,this._numJoints=t,this._jointsBuffer=new Float32Array(this._numJoints*16),this._jointMatrices=[];const n=this._jointsBuffer.buffer;for(let s=0;s<this._numJoints;s++)this._jointMatrices.push(new Float32Array(n,s*16*4,16))}get numJoints(){return this._numJoints}get jointMatrices(){return this._jointMatrices}setup(t){t[Je](this._jointsBuffer)}_genCode(t){t.add("pv",Be.preVertexCode(this)),t.add("vertex_warp",Be.vertexCode())}}function cn(e){if(e<1||e>4)throw new Error("number is not Component size")}function ln(e){if(e!=="position"&&e!=="normal"&&e!=="tangent")throw new Error(`semantic ${e} can't be morphed`)}class hn{constructor(t,r){this._skinDeformers=new Map,this._morphDeformers=new Map,this.materials=[],this.bounds=new Ee,j.isDefined(r.mesh),this.node=r,this.mesh=r.mesh,this.setupMaterials(t),this.computeBounds()}setupMaterials(t){for(const r of this.mesh.primitives){const n=r.material.createMaterialForPrimitive(t,this.node,r);this.configureDeformers(n,r),this.materials.push(n)}}configureDeformers(t,r){this.configureSkin(t,r),this.configureMorph(t,r)}configureMorph(t,r){if(r.targets!==null){const n=r.targets[0].attributes,s=[];for(const a of n){const c=r.targets.map(o=>o.getSemantic(a.semantic).glslname),l=a.semantic.toLowerCase();ln(l);const h={name:l,type:a.accessor.glslType,attributes:c};s.push(h)}const i=new en(s);t.inputs.add(i),this._morphDeformers.set(r,i),this.setupMorphWeights(i)}}setupMorphWeights(t){this.node.weights?t.weights=this.node.weights:this.mesh.weights&&(t.weights=this.mesh.weights)}configureSkin(t,r){if(this.node.skin){const n=this.node.skin.joints.length,s=[];let i=0;for(;;){const c="WEIGHTS_"+i,l="JOINTS_"+i,h=r.attributes.getSemantic(c),o=r.attributes.getSemantic(l);if(h===null!=(o===null))throw new Error("Skin attributes inconsistency");if(h===null)break;if(h.accessor.numComps!==o.accessor.numComps)throw new Error("weight and joints attribute dont have the same size");const m=h.accessor.numComps;cn(m),s.push({weightsAttrib:h.glslname,jointsAttrib:o.glslname,numComponents:m}),i++}const a=new an(n,s);t.inputs.add(a),this._skinDeformers.set(r,a)}}computeBounds(){this.bounds.copyFrom(this.mesh.primitives[0].bounds);for(const t of this.mesh.primitives)Ee.union(this.bounds,this.bounds,t.bounds)}render(t,r,n,s,i){const a=this.mesh.primitives,c=Et.get(t);for(let l=0;l<a.length;l++){const h=a[l];this._skinDeformers.has(h)&&this.node.skin.computeJoints(this.node,this._skinDeformers.get(h).jointMatrices),this._morphDeformers.has(h)&&this.setupMorphWeights(this._morphDeformers.get(h));const o=this.materials[l];if(!o.hasPass(s)||!(o.mask&n))continue;const m=o.getPass(s);m.pass.mask&n&&(m.prepare(this.node,r),c.push(m.pass.glconfig),o.glconfig&&c.push(o.glconfig),this.glconfig&&c.push(this.glconfig),i&&c.push(i),c.apply(),this.drawCall(r,m.getProgram(),h),c.pop(),o.glconfig&&c.pop(),this.glconfig&&c.pop(),i&&c.pop())}}drawCall(t,r,n){n.bindVao(r),n.render(),n.unbindVao()}}class on extends Ge{constructor(){super(...arguments),this.gltftype=f.NODE,this.weights=null}async parse(t,r){var n,s;if(this.extras=r.extras,r.camera!==void 0&&(this.camera=await t.getElement(f.CAMERA,r.camera)),r.matrix!==void 0&&this.setMatrix(new Float32Array(r.matrix)),r.scale!==void 0&&this.scale.set(r.scale),r.translation!==void 0&&this.position.set(r.translation),r.rotation!==void 0&&this.rotation.set(r.rotation),r.children!==void 0){const i=r.children.map(c=>t.getElement(f.NODE,c)),a=await Promise.all(i);for(const c of a)this.add(c)}if(r.skin!==void 0&&(this.skin=await t.getElement(f.SKIN,r.skin)),r.mesh!==void 0){this.mesh=await t.getElement(f.MESH,r.mesh);const i=this.mesh.primitives[0].targets;i&&(this.weights=new Float32Array(i.length))}if(r.weights!==void 0){if(this.weights===null||this.weights.length!==r.weights.length)throw new Error("morph weights on node doesn't match mesh targets");this.weights.set(r.weights)}this.name=(n=r.name)!==null&&n!==void 0?n:(s=this.mesh)===null||s===void 0?void 0:s.name,this.invalidate()}findChild(t){for(let r=0;r<this._children.length;r++){const n=this._children[r];if(n.name===t)return n}}findDescendant(t){var r;let n=this.findChild(t);if(n===void 0)for(let s=0;s<this._children.length;s++){const i=this._children[s];if(n=(r=i.findDescendant)===null||r===void 0?void 0:r.call(i,t),n!==void 0)return n}return n}allocateGl(t){this.mesh&&(this.renderable=new hn(t,this))}}function fn(e,t){return new Promise((r,n)=>{t.addEventListener("abort",s=>n(s)),e.then(r,n)})}let _e;typeof window<"u"&&window.AbortController!==void 0?_e=e=>{const t=new AbortController;return e.addEventListener("abort",()=>t.abort()),t.signal}:_e=e=>{};const fe=_e,mn=10497,pn=33648;function Ve(e){return(e&1<<8)===1<<8}function Ue(e){return e===mn||e===pn}function we(e){return e!=0&&(e&e-1)===0}function De(e){return we(e)?e:(e%2===1&&e++,Math.pow(2,Math.round(Math.log(e)/Math.log(2))))}class un{constructor(){this.gltftype=f.IMAGE}get hasAlpha(){return this.mimeType!==y.ImageMimeType.JPEG}async parse(t,r){r.uri&&(this.uri=r.uri,this.uri.indexOf("data:")==0?this.resolvedUri=this.uri:this.resolvedUri=t.resolveUri(this.uri)),this.mimeType=r.mimeType,r.bufferView!==void 0&&(this.bufferView=await t.getElement(f.BUFFERVIEW,r.bufferView)),await this.loadImage(t)}async loadImage(t){const r=await this.loadImageBlob(t.abortSignal);this.texImageSource=await t.gltfIO.loadImageBlob(r,t.abortSignal)}async loadImageBlob(t){if(this.bufferView){const r=new Uint8Array(this.bufferView.buffer._bytes,this.bufferView.getByteOffset(),this.bufferView.byteLength);return new Blob([r],{type:this.mimeType})}else{const r=fe(t);return await(await fetch(this.resolvedUri,{signal:r})).blob()}}async setupTexture(t,r,n,s,i){const a=t.gl;let c=this.texImageSource;(Ue(r)||Ue(n)||Ve(s))&&(!we(c.width)||!we(c.height))&&(c=await this.resizeToPOT(c,a)),t.fromImage(this.texImageSource),Ve(s)&&a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,s),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n)}async resizeToPOT(t,r){const n=document.createElement("canvas"),s=n.getContext("2d");if(n.width=De(t.width),n.height=De(t.height),t instanceof ImageData){const i=await createImageBitmap(t,0,0,n.width,n.height,{});s.drawImage(i,0,0,n.width,n.height)}else s.drawImage(t,0,0,n.width,n.height);return n}}class dn{constructor(){this.gltftype=f.ASSET}parse(t,r){return this.version=r.version,this.copyright=r.copyright,this.generator=r.generator,this.minVersion=r.minVersion,Promise.resolve()}}class En{constructor(){this.gltftype=f.BUFFER}async parse(t,r){this.byteLength=r.byteLength,this.uri=r.uri,this._byteOffset=0,this._bytes=await t.loadBufferUri(r.uri),j.isTrue(this._bytes!==null)}}class gn{constructor(){this.gltftype=f.BUFFERVIEW,this.byteOffset=0,this.byteLength=0,this.byteStride=0,this.target=0,this.glBuffer=null,this.glBufferTarget=0}async parse(t,r){const{byteLength:n,byteOffset:s=0,byteStride:i=0,target:a=0}=r;this.byteLength=n,this.byteOffset=s,this.byteStride=i,this.target=a,this.buffer=await t.getElement(f.BUFFER,r.buffer)}getByteOffset(){return this.byteOffset+this.buffer._byteOffset}getWebGLBuffer(t,r){if(this.target!==0&&this.target!==r)throw new Error(`BufferView's target ${this.target} doesn't match infered one ${r}`);if(this.glBuffer!==null){if(this.glBufferTarget!==r)throw new Error("WebglBuffers with different target requested on BufferView")}else{const n=new Uint8Array(this.buffer._bytes,this.getByteOffset(),this.byteLength);this.glBufferTarget=r,this.glBuffer=t.createBuffer(),t.bindBuffer(r,this.glBuffer),t.bufferData(r,n,t.STATIC_DRAW),t.bindBuffer(r,null)}return this.glBuffer}}class An{constructor(){this.gltftype=f.ACCESSOR_SPARSE}async parse(t,r,...n){this.accessor=await t.getElement(f.ACCESSOR,r.elementParent.elementIndex),this.indices=await t._loadElement(r.indices),this.values=await t._loadElement(r.values);const s=this.indicesSet=new Set,i=this.indicesMap=new Map,a=this.indices,c=a.count;for(let l=0;l<c;l++){const h=a.getScalar(l);s.add(h),i.set(h,l)}}getRawValue(t,r){this.indicesSet.has(r)?this.values.getRawValue(t,this.indicesMap.get(r)):this.accessor.getRawValue(t,r)}getRawScalar(t){return this.indicesSet.has(t)?this.values.getRawScalar(this.indicesMap.get(t)):this.accessor.getRawScalar(t)}}class _n extends ye{constructor(){super(...arguments),this.gltftype=f.ACCESSOR_SPARSE_INDICES}async parse(t,r){var n;const s=r.elementParent;this.normalized=!1,this.byteOffset=(n=r.byteOffset)!==null&&n!==void 0?n:0,this.componentType=r.componentType,this.count=s.count,this.type=y.AccessorType.SCALAR,this.sparse=null,this.bufferView=await t.getElement(f.BUFFERVIEW,r.bufferView);const i=re(this.componentType);return this.bufferView.byteStride===0?(this._stride=this.numComps*this.bytesPerElem,this._strideElem=this.numComps):(this._stride=this.bufferView.byteStride,this._strideElem=this._stride/i.BYTES_PER_ELEMENT,j.isTrue(this._strideElem===Math.round(this._strideElem))),this._array=new i(this.bufferView.buffer._bytes,this.byteOffset+this.bufferView.getByteOffset(),this.count*this._strideElem),this._valueHolder=this.createElementHolder(),Promise.resolve()}}class wn extends ye{constructor(){super(...arguments),this.gltftype=f.ACCESSOR_SPARSE_VALUES}async parse(t,r){var n,s;const i=r.elementParent,a=i.elementParent;this.byteOffset=(n=r.byteOffset)!==null&&n!==void 0?n:0,this.count=i.count,this.normalized=(s=a.normalized)!==null&&s!==void 0?s:!1,this.componentType=a.componentType,this.type=a.type,this.sparse=null,this.bufferView=await t.getElement(f.BUFFERVIEW,r.bufferView);const c=re(this.componentType);return this.bufferView.byteStride===0?(this._stride=this.numComps*this.bytesPerElem,this._strideElem=this.numComps):(this._stride=this.bufferView.byteStride,this._strideElem=this._stride/c.BYTES_PER_ELEMENT,j.isTrue(this._strideElem===Math.round(this._strideElem))),this._array=new c(this.bufferView.buffer._bytes,this.byteOffset+this.bufferView.getByteOffset(),this.count*this._strideElem),this._valueHolder=this.createElementHolder(),Promise.resolve()}}class vn{constructor(t){this.name="default",this.priority=0,this.loader=t}acceptElement(t,r){return null}loadElement(t){switch(t.gltftype){case f.ACCESSOR:return this.createAccessor(t);case f.ACCESSOR_SPARSE:return this.createAccessorSparse(t);case f.ACCESSOR_SPARSE_INDICES:return this.createAccessorSparseIndices(t);case f.ACCESSOR_SPARSE_VALUES:return this.createAccessorSparseValues(t);case f.ANIMATION:return this.createAnimation(t);case f.ANIMATION_SAMPLER:return this.createAnimationSampler(t);case f.ANIMATION_CHANNEL:return this.createAnimationChannel(t);case f.ASSET:return this.createAsset(t);case f.BUFFER:return this.createBuffer(t);case f.BUFFERVIEW:return this.createBufferview(t);case f.CAMERA:return this.createCamera(t);case f.IMAGE:return this.createImage(t);case f.MATERIAL:return this.createMaterial(t);case f.MESH:return this.createMesh(t);case f.NODE:return this.createNode(t);case f.NORMAL_TEXTURE_INFO:return this.createNormalTextureInfo(t);case f.OCCLUSION_TEXTURE_INFO:return this.createOcclusionTextureInfo(t);case f.PRIMITIVE:return this.createPrimitive(t);case f.SAMPLER:return this.createSampler(t);case f.SCENE:return this.createScene(t);case f.SKIN:return this.createSkin(t);case f.TEXTURE:return this.createTexture(t);case f.TEXTURE_INFO:return this.createTextureInfo(t)}}async createAccessor(t){const r=new vr;return await r.parse(this.loader,t),r}async createAccessorSparse(t){const r=new An;return await r.parse(this.loader,t),r}async createAccessorSparseIndices(t){const r=new _n;return await r.parse(this.loader,t),r}async createAccessorSparseValues(t){const r=new wn;return await r.parse(this.loader,t),r}async createAsset(t){const r=new dn;return await r.parse(this.loader,t),r}async createBuffer(t){const r=new En;return await r.parse(this.loader,t),r}async createBufferview(t){const r=new gn;return await r.parse(this.loader,t),r}async createAnimationChannel(t){const r=new Wt;return await r.parse(this.loader,t),r}async createAnimationSampler(t){const r=new or;return await r.parse(this.loader,t),r}async createAnimation(t){const r=new zt;return await r.parse(this.loader,t),r}async createCamera(t){const r=new yr;return await r.parse(this.loader,t),r}async createImage(t){const r=new un;return await r.parse(this.loader,t),r}async createMaterial(t){const r=new Ir;return await r.parse(this.loader,t),r}async createMesh(t){const r=new br;return await r.parse(this.loader,t),r}async createNode(t){const r=new on;return await r.parse(this.loader,t),r}async createNormalTextureInfo(t){const r=new Nr;return await r.parse(this.loader,t),r}async createOcclusionTextureInfo(t){const r=new Pr;return await r.parse(this.loader,t),r}async createPbrMetallicRoughness(t){const r=new je;return await r.parse(this.loader,t),r}async createPrimitive(t){const r=new zr;return await r.parse(this.loader,t),r}async createSampler(t){const r=new Gr;return await r.parse(this.loader,t),r}async createScene(t){const r=new Hr;return await r.parse(this.loader,t),r}async createSkin(t){const r=new Yr;return await r.parse(this.loader,t),r}async createTexture(t){const r=new kr;return await r.parse(this.loader,t),r}async createTextureInfo(t){const r=new Cr;return await r.parse(this.loader,t),r}}class yn{constructor(){this.name="default"}createInstance(t){return new vn(t)}}const Sn=new yn;H.addExtension(Sn);let xn=0;function Tn(){return xn+++""}const Mn={gltftype:f.MATERIAL,elementIndex:-1,elementParent:null,uuid:"_default_mat_",name:"default"};class Rn{constructor(t,r){this.data=t,this.promise=r}}const In=1179937895,bn=1313821514,ze=20,Cn=9729;class Nn{constructor(t,r,n={}){var s,i;this._elements=new Map,this._pendingElements=[],this._byType=new Map,this._propertyMaps=new Map,this.loadBufferUri=a=>{if(a===void 0)return Promise.resolve(this._glbData);const c=this.gltfIO.resolvePath(a,this._baseUrl);return this.gltfIO.loadBinaryResource(c,this.abortSignal)},this.gltfIO=t,this._url=r,this._baseUrl=n.baseurl,this.abortSignal=(s=n.abortSignal)!==null&&s!==void 0?s:q.none,this.defaultTextureFilter=(i=n.defaultTextureFilter)!==null&&i!==void 0?i:Cn,this._baseUrl===void 0&&([this._baseUrl,this._url]=t.resolveBaseDir(this._url)),this.gltf=new H,this._data=null,this._extensions=new Nt,H.getExtensionsRegistry().setupExtensions(this,n.extensions)}async load(){const t=await this.gltfIO.loadBinaryResource(this.gltfIO.resolvePath(this._url,this._baseUrl),this.abortSignal);return this.unpack(t),await this.parseAll(),this.gltf}unpack(t){if(new Uint32Array(t,0,1)[0]===In)this.unpackGlb(t);else{const n=this.gltfIO.decodeUTF8(t);this._data=JSON.parse(n),this.prepareGltfDatas(this._data)}}unpackGlb(t){const[,r,,n,s]=new Uint32Array(t,0,5);if(r!==2)throw new Error("Binary glTF version is not 2");if(s!==bn)throw new Error("Binary glTF scene format is not JSON");const i=this.gltfIO.decodeUTF8(t,ze,n);this._glbData=t.slice(ze+n+8),this._data=JSON.parse(i),this.prepareGltfDatas(this._data)}resolveUri(t){return this.gltfIO.resolvePath(t,this._baseUrl)}parseCommonGltfProperty(t,r){r.name===void 0&&(r.name=t.name),r.extras===void 0&&(r.extras=t.extras)}async _createElement(t){const r=await this._createElementInstance(t);return this.parseCommonGltfProperty(t,r),this._extensionsAccept(t,r)}_createElementInstance(t){const r=this._extensions._list;for(const n of r){const s=n.loadElement(t);if(s===void 0)throw new Error("extension should not return undefined");if(s!==null)return s}throw new Error("Unhandled type")}async _extensionsAccept(t,r){const n=this._extensions._list;let s;for(const i of n)s=i.acceptElement(t,r),s!==null&&(r=await s);return r}_loadElement(t){let r=this._elements.get(t.uuid);if(r===void 0){r=this._createElement(t);const n=new Rn(t,r);this._pendingElements.push(n),this._elements.set(t.uuid,r)}return r}loadDefaultMaterial(){return this._loadElement(Mn)}_getElementHolder(t){let r=this._byType.get(t);return r===void 0&&(r=[],this._byType.set(t,r)),r}getElement(t,r){const n=this._getElementHolder(t);if(n[r]!==void 0)return n[r];const i=this._propertyMaps.get(t)[r];return this._loadElement(i)}async parseAll(){this._extensions.validate(this._data.extensionsUsed,this._data.extensionsRequired);const t=await this._loadElement(this._data.asset);t.version!="2.0"&&console.warn(`Gltf version should be "2.0" found "${t.version}"`),await this._loadElements(this._data.nodes),await this._loadElements(this._data.animations),await this.resolveElements()}_loadElements(t){if(t!==void 0){const r=t.map(n=>this._loadElement(n));return Promise.all(r).then()}}async resolveElements(){for(;this._pendingElements.length>0;){const t=this._pendingElements.splice(0,this._pendingElements.length),r=await Promise.all(t.map(n=>n.promise));for(let n=0;n<t.length;n++){const s=r[n];j.isDefined(s.gltftype),this.gltf.addElement(r[n],t[n].data.elementIndex)}}}prepareGltfDatas(t){if(this.prepareGltfRootProperties(t.accessors,f.ACCESSOR,null),this.prepareGltfRootProperties(t.animations,f.ANIMATION,null),this.prepareGltfRootProperties([t.asset],f.ASSET,null),this.prepareGltfRootProperties(t.buffers,f.BUFFER,null),this.prepareGltfRootProperties(t.bufferViews,f.BUFFERVIEW,null),this.prepareGltfRootProperties(t.cameras,f.CAMERA,null),this.prepareGltfRootProperties(t.images,f.IMAGE,null),this.prepareGltfRootProperties(t.materials,f.MATERIAL,null),this.prepareGltfRootProperties(t.meshes,f.MESH,null),this.prepareGltfRootProperties(t.nodes,f.NODE,null),this.prepareGltfRootProperties(t.samplers,f.SAMPLER,null),this.prepareGltfRootProperties(t.scenes,f.SCENE,null),this.prepareGltfRootProperties(t.skins,f.SKIN,null),this.prepareGltfRootProperties(t.textures,f.TEXTURE,null),t.animations!==void 0)for(const r of t.animations)this.prepareGltfProperties(r.samplers,f.ANIMATION_SAMPLER,r),this.prepareGltfProperties(r.channels,f.ANIMATION_CHANNEL,r);if(t.materials!==void 0)for(const r of t.materials)this.prepareGltfProperty(r.normalTexture,f.NORMAL_TEXTURE_INFO,-1,r),this.prepareGltfProperty(r.occlusionTexture,f.OCCLUSION_TEXTURE_INFO,-1,r),this.prepareGltfProperty(r.emissiveTexture,f.TEXTURE_INFO,-1,r),r.pbrMetallicRoughness!==void 0&&(this.prepareGltfProperty(r.pbrMetallicRoughness.baseColorTexture,f.TEXTURE_INFO,-1,r),this.prepareGltfProperty(r.pbrMetallicRoughness.metallicRoughnessTexture,f.TEXTURE_INFO,-1,r));if(t.meshes!==void 0)for(const r of t.meshes)this.prepareGltfProperties(r.primitives,f.PRIMITIVE,r);if(t.accessors!==void 0)for(const r of t.accessors)this.prepareGltfProperty(r.sparse,f.ACCESSOR_SPARSE,-1,r),r.sparse!==void 0&&(this.prepareGltfProperty(r.sparse.indices,f.ACCESSOR_SPARSE_INDICES,-1,r.sparse),this.prepareGltfProperty(r.sparse.values,f.ACCESSOR_SPARSE_VALUES,-1,r.sparse))}prepareGltfProperties(t,r,n){if(t!==void 0)for(let s=0;s<t.length;s++){const i=t[s];this.prepareGltfProperty(i,r,s,n)}}prepareGltfRootProperties(t,r,n){if(t!==void 0){this._propertyMaps.set(r,t);for(let s=0;s<t.length;s++){const i=t[s];this.prepareGltfProperty(i,r,s,n)}}}prepareGltfProperty(t,r,n,s){t!==void 0&&(t.gltftype=r,t.uuid=Tn(),t.elementIndex=n,t.elementParent=s)}}class Pn{constructor(t){this._ioImpl=t}loadGltf(t,r={}){return new Nn(this._ioImpl,t,r).load()}}async function On(){if(typeof window>"u"||window.createImageBitmap===void 0)return!1;const r=await(await fetch("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=")).blob();try{await window.createImageBitmap(r,{premultiplyAlpha:"none",colorSpaceConversion:"none"})}catch{return!1}return!0}const Fn=On();function Ln(e){const t=e.lastIndexOf("/");return[e.substr(0,t),e.substr(t+1)]}class Bn{isDataURI(t){return t.indexOf("data:")===0}decodeDataURI(t){if(t.indexOf("data:")!==0)throw new Error("invalid dataURI");const r=t.substr(t.indexOf(",")+1);return me.toByteArray(r).buffer}resolveBaseDir(t){return Ln(t)}resolvePath(t,r){return r===void 0||this.isDataURI(t)?t:r+"/"+t}decodeUTF8(t,r=0,n=void 0){return n===void 0&&(n=t.byteLength-r),Ct(new Uint8Array(t,r,n))}async loadResource(t,r=q.none){const n=fe(r);return(await fetch(t,{signal:n})).text()}async loadBinaryResource(t,r=q.none){if(this.isDataURI(t))return this.decodeDataURI(t);const n=fe(r);return(await fetch(t,{signal:n})).arrayBuffer()}async loadImageBuffer(t,r,n=q.none){const s=new Blob([t],{type:r});return this.loadImageBlob(s,n)}async loadImage(t,r=q.none){const n=fe(r),i=await(await fetch(t,{signal:n})).blob();return this.loadImageBlob(i,r)}async loadImageBlob(t,r){let n;if(await Fn)n=createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"});else{const i=new window.Image,a=URL.createObjectURL(t);n=new Promise((l,h)=>{i.onload=l,i.onerror=h,i.src=a}).finally(()=>URL.revokeObjectURL(a)).then(()=>i)}return fn(n,r)}writeResource(t,r){throw new Error("Method not implemented.")}writeBinaryResource(t,r){throw new Error("Method not implemented.")}}const Vn=new Bn,$n=new Pn(Vn);export{$n as _};
